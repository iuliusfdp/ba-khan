{% extends 'home.html' %}
{% load static %}
{% load  smart_if %}

{% block title %}
	Dashboard
{% endblock %}

{% block head %}
{% endblock %}

{% block body2 %}	
<style>
	.tipsy{
		width:250px;
	}

	tr:hover {
		background-color: #BFDAB3; /* resaltar filas */
	}

#box2000 > div
{
    -webkit-transition: width 0.2s ease; 
    -moz-transition: width 0.2s ease; 
    -o-transition: width 0.2s ease; 
    -ms-transition: width 0.2s ease;     
    transition: width 0.2s ease; 
}
#box2000 > div:hover
{
    width:120%!important;
    cursor:pointer;
    border-radius: 5px;
}
</style>

	<div id="popup" class="popup" style="display:none">
    	<div id="close">X</div>
    	<div style="align:center;margin-left:6%;width:90%">
	    	<form method="post" id='formGrade'>{% csrf_token %}
				<div id="popup_nombre"><p id="pgrade" style="margin-top:0px;"><strong>Nombre del Estudiante</strong></p></div>
				<p id="pgrade">  Nota:<input name="input_grade" id="input_grade" class="vaciar" type="text" style="width:30px;padding:5px;margin-left:385px;" disabled/></p>
				<p id="pgrade">+ Bonificación por Esfuerzo:
					<input name="input_bonificacion" id="input_bonificacion" class="vaciar" type="text" style="width:30px;padding:5px;margin-left:245px;" disabled/>
				</p>
				<p id="pgrade">--------------------------------------------------------------------------------------------------------------</p>
				<p id="pgrade">  Nota sugerida: <input id="sugerida" class="vaciar" type="text" style="align:left;width:30px;padding:5px;margin-left:324px;" disabled/></p>
				<p id="pgrade"><input name="input_grade_id" id="input_grade_id" class="vaciar" type="text" style="display:none"/></p>
				<p id="pgrade">+ Bonificación del Profesor:
				{% if isTeacher %}
					<input name="input_grade_teacher" id="input_grade_teacher" onChange="autoCalculateGrade()" onkeyup="autoCalculateGrade()" class="ui-corner-all placeholder simple-input search-input blur-on-esc vaciar" type="text" style="width:19px;margin-left:246px;"/>
				{% else %}
					<input name="input_grade_teacher" id="input_grade_teacher"  class="ui-corner-all placeholder simple-input search-input blur-on-esc vaciar" type="text" style="width:19px;margin-left:246px;" disabled />
				{% endif %}
				
					
				</p>
				<p id="pgrade">--------------------------------------------------------------------------------------------------------------</p>
				<p id="pgrade">  Nota Final: <input class="vaciar" id="final" type="text" style="width:30px;padding:5px;margin-left:348px;" disabled/></p>
				<p style="margin-top:10px;margin-bottom:0px;">Comentario:
					{% if isTeacher %}
					<textarea id="textarea_coment" class="ui-corner-all placeholder simple-input search-input blur-on-esc vaciar" style="width:440px;height:50px;padding-top:5px"></textarea>
					{% else %}
					<textarea id="textarea_coment" class="ui-corner-all placeholder simple-input search-input blur-on-esc vaciar" style="width:440px;height:50px;padding-top:5px" disabled></textarea>
					{% endif %}
					<input name="input_comment" class="vaciar" id="input_comment" type="text" style="display:none;"/>
				</p>
			</form>
			{% if isTeacher %}
			<div><input type="button" onClick="modificarNota()" class="kui-button kui-button-plain kui-button-primary" style="margin-left:-100px;" value="Modificar Nota"></div>
			{% endif %}
    	</div>
    </div>

    <div id="popup_resumen" class="popup" style="display:none">
    	<div id="close-resumen"  onClick="$('#popup_resumen').fadeOut();$('#hover').fadeOut();">X</div>
    	<div id="inside_resumen" style="align:left; height:100%; width:100%">
	    	<h2 style="text-align:center;">Resumen</h2>
	    	<div id="resumen_data"></div>
	    	<h4>Histograma de notas:</h4>
	    	<div id="resumen_graph" class="resumen_graph"></div>
	    	<div id="skills_boxplot" class="resumen_graph"></div>
	    	<hr><h4>Habilidades:</h4>
	    	<div id="resumen_skill"></div>
	    	<!--<div id="resumen_grade" class="resumen_grade"></div>
	    	<div id="resumen_grade_count" class="resumen_grade"></div>-->
	    	
    	</div>
    </div>

    <div id="popup_error" class="popup" style="display:none">
    	<div id="close" onClick="$('#popup_error').fadeOut();$('#hover').fadeOut();">X</div>
    	<div style="align:left;">
	    	<div id="popupEvaluacion"></div>
	    	<div id="botonesEvaluacion">
	    		<a class='kui-button kui-button-plain kui-button-primary' id="evAceptar">Aceptar</a>
	    		<a class='kui-button kui-button-plain kui-button-primary' id="evCancelar">Cancelar</a>
    		</div>
    	</div>
    </div>
    {% if isTeacher %}
	<div style="margin:10px"><button class="kui-button kui-button-plain kui-button-primary" onclick="nuevaEvaluacion()"><i class="plus"></i> Nueva Calificación</button></div> 
	{% endif %}
	<form action="" method="post" id='formJson'>{% csrf_token %}
	<div id="contenido_a_mostrar" style="display:none;" value=>
		<div id="inputs" align="left">
			<p class="label_input"><strong>Pauta de Evaluación</strong></p>
			<select id="comboBox" class="skill_search" onClick="validarRealizarEvaluacion();" onChange="fillParameters(this.value);">
				<OPTION VALUE=0>Seleccionar Pauta</OPTION>
				{% for config in assesment_configs %}
					<OPTION VALUE="{{config.id_assesment_config}}">{{config.name}}</OPTION>
				{% endfor %}
			</select>
				<p class="label_input"><strong>Nombre de la Calificación</strong></p>
				<input name="input_nombre" onkeyup="validarRealizarEvaluacion()" id="input_nombre" class="ui-corner-all placeholder simple-input search-input blur-on-esc skill_search" type="text" placeholder="Nombre de la Calificación"/>
				<p class="label_input"><strong>Nota Mínima</strong></p>
				<input name="nota_minima" onkeyup="validarRealizarEvaluacion()" id="nota_minima" class="ui-corner-all placeholder simple-input search-input blur-on-esc skill_search" type="number" min="0" placeholder="Nota mínima"/>
				<p class="label_input"><strong>Nota Máxima</strong></p>
				<input name="nota_maxima" onkeyup="validarRealizarEvaluacion()" id="nota_maxima" class="ui-corner-all placeholder simple-input search-input blur-on-esc skill_search" type="number" min="0" placeholder="Nota máxima"/>
				<p class="label_input"><strong>Nota de Aprobación</strong></p>
				<input name="nota_aprobacion" onkeyup="validarRealizarEvaluacion()" id="nota_aprobacion" class="ui-corner-all placeholder simple-input search-input blur-on-esc skill_search" type="number" min="0" placeholder="Nota aprobacion"/>
				<p class="label_input"><strong>Bonificación por esfuerzo</strong></p>
				<input name="bono_esfuerzo" onkeyup="validarRealizarEvaluacion()" id="bono_esfuerzo" class="ui-corner-all placeholder simple-input search-input blur-on-esc skill_search" type="number" min="0" placeholder="Bonificación por esfuerzo"/>
				<input name="input_id_config" id="input_id_config" style="display:none;">
				<input name="input_kaid" id="input_kaid" style="display:none;">
				<input name="input_id_assesment" id="input_id_assesment" style="display:none;">
				<input name="input_id_class" id="input_id_class" style="display:none;">
			</form>
		</div>
		<div class="parametros" id="parametros"><strong>Parámetros</strong></div>
		<div class="skills" id="skills" align="left"><strong>Habilidades</strong></div>
		<div>
			<div style="padding-left:220px;margin-bottom:-10px"><strong>Estudiantes No Calificados</strong></div>	
			<div id="sinEvaluar" class="sinEvaluar" ondragenter="return enter(event)" ondragover="return over(event)" ondragleave="return leave(event)" ondrop="return drop(event)"></div>
		</div>
	    <div class="flechas"><IMG id='flechaTodos' style='width:55px;height:55px;cursor:pointer;cursor:hand;' SRC="{% static 'img/arrow5b.svg'%}" onClick="EvaluarTodos()"></div>
	    <div>
			<div id="estudiantesEvaluados" style="padding-left:220px;margin-bottom:-10px"></div>	
			<div id="Evaluados" class="Evaluados" ondragenter="return enter(event)" ondragover="return over(event)" ondragleave="return leave(event)" ondrop="return drop(event)"></div>				
		</div>
		<div class="flechas"><IMG id='flechaNinguno' style='width:55px;height:55px;cursor:pointer;cursor:hand;' SRC="{% static 'img/arrow5a.svg'%}" onClick="noEvaluarTodos()"></div>
		<div class="cntFechas" style="margin-left:200px;margin-right: 100px;">
				<div style="height:50px;width:200px;" class="fechas">
					<p class="label_input"><strong>Fecha de Inicio</strong></p>
					<input name="fecha_inicio" onchange="validarRealizarEvaluacion()" onkeyup="validarRealizarEvaluacion()" id="fecha_inicio" class="ui-corner-all placeholder simple-input search-input blur-on-esc skill_search" type="date" placeholder="Fecha inicio"/>
				</div>
				<div style="height:50px;width:200px;" class="fechas">
					<p class="label_input"><strong>Fecha de Término</strong></p>
					<input name="fecha_termino" onchange="validarRealizarEvaluacion()" onkeyup="validarRealizarEvaluacion()" id="fecha_termino" class="ui-corner-all placeholder simple-input search-input blur-on-esc skill_search" type="date" placeholder="Fecha término"/>
				</div>
		</div>

		<div align="right" style="padding-left: 500px;margin-left: 165px;margin-top: 145px;">
			<div style="float:left;margin:2px;" align="center"><input type="button" id="button_realizar" onClick="realizarEvaluacion();" class="kui-button kui-button-plain kui-button-primary" value="Iniciar Calificación"></div>
			<div style="float:left;margin:2px;" align="center"><input type="button" id="button_editar" name="" onClick="updateAssesment()" class="kui-button kui-button-plain kui-button-primary" value="Editar Evaluación" style="display:none"></div>
			<div style="float:left;margin:2px;" align="center"><input type="button" id="button_cancelar" onClick="cancelNewEv();" class="kui-button kui-button-plain kui-button-primary" value="Cancelar"></div>
		</div>
	</div>
	</form>

	<script type="text/javascript">	
		var Needle = (function() {
	        /** 
	          * Helper function that returns the `d` value
	          * for moving the needle
	        **/
	        var recalcPointerPos = function(perc) {
	          var centerX, centerY, leftX, leftY, rightX, rightY, thetaRad, topX, topY;
	          thetaRad = percToRad(perc / 2);
	          centerX = 0;
	          centerY = 0;
	          topX = centerX - this.len * Math.cos(thetaRad);
	          topY = centerY - this.len * Math.sin(thetaRad);
	          leftX = centerX - this.radius * Math.cos(thetaRad - Math.PI / 2);
	          leftY = centerY - this.radius * Math.sin(thetaRad - Math.PI / 2);
	          rightX = centerX - this.radius * Math.cos(thetaRad + Math.PI / 2);
	          rightY = centerY - this.radius * Math.sin(thetaRad + Math.PI / 2);
	          return "M " + leftX + " " + leftY + " L " + topX + " " + topY + " L " + rightX + " " + rightY;
	        };

	        function Needle(el,id) {
	          
	          this.el = el;
	          this.id = id;
	          this.len = 24;//width / 3;
	          this.radius = 4;//this.len / 6;
	        }

	        Needle.prototype.render = function() {
	          this.el.append('circle').attr('class', 'needle-center').attr('cx', 0).attr('cy', 0).attr('r', this.radius);
	          return this.el.append('path').attr('class', 'needle').attr('d', recalcPointerPos.call(this,0));
	        };

	        Needle.prototype.moveTo = function(perc) {
	          var self,
	              oldValue = this.perc || 0;

	          this.perc = perc;
	          self = this;
	          
	          var id=this.id;

	          // Reset pointer position
	          this.el.transition().delay(100).ease('quad').duration(200).select('.needle').tween('reset-progress', function() {
	            return function(percentOfPercent) {
	              var progress = (1 - percentOfPercent) * oldValue;
	              repaintGauge(progress,id);
	              return d3.select(this).attr('d', recalcPointerPos.call(self, progress));
	            };
	          });

	          this.el.transition().delay(300).ease('bounce').duration(1500).select('.needle').tween('progress', function() {
	            return function(percentOfPercent) {
	              var progress = percentOfPercent * perc;
	              repaintGauge(progress,id);
	              return d3.select(this).attr('d', recalcPointerPos.call(self, progress));
	            };
	          });
	        };
	        return Needle;
	    })();
	</script>
	
	<script type="text/javascript">
	var evReady = 0;
	$(document).ready(function(){
  		noEvaluarTodos();
  		$("#hover").click(function(){
  	        $(this).fadeOut();
  	    	$("#popup").fadeOut();
  	    	$("#popup_resumen").fadeOut();
  	    	$("#popup_evaluacion").fadeOut();
  	    	$("#popup_error").fadeOut();

  	    });
  	  	$("#close").click(function(){
  	        $("#hover").fadeOut();
  	    	$("#popup").fadeOut();
  	    	$("#popup_resumen").fadeOut();
  	    });

  	  	//This code was for using a pop up menu to choose the row sorting criterion
  	  	//$('body').append('<div id="sortMenu" class="sortMenu-content"><ul><li class="sortMenu-header">Ordenar por...</li><li class="sortMenu-option">Nota</li><li class="sortMenu-option">Esfuerzo</li></ul></div>');
  		
  	  	$("select.assesment").on('change', function() {
  	  		var sortingCriterion = $(this).val();
  	  		//console.log(sortingCriterion);
  	  		var assesmentName = $(this).attr("name");
		    //d3.selectAll("td."+assesmentName).attr("data-sortAs",function(d){console.log(d);return d.value[sortingCriterion];})
		    d3.selectAll("td."+assesmentName).attr("data-sortAs",function(d){return d.value[sortingCriterion];})
		});
  	  	
  	  	$("select.skills_level").on('change', function() {
  	  		var sortingCriterion = $(this).val();
  	  		if (sortingCriterion =="total"){
  	  			d3.selectAll("td.skills_level").attr("data-sortAs",function(d){
  	  				return d.values["mastery3"]+d.values["mastery2"]+d.values["mastery1"]+d.values["practiced"]+d.values["struggling"];
  	  			});
  	  		}else{
		    	d3.selectAll("td.skills_level").attr("data-sortAs",function(d){return d.values[sortingCriterion];});
  	  		}
		});
  	  	
  	  	$("select.exercises").on('change', function() {
  	  		var sortingCriterion = $(this).val();
  	  		if (sortingCriterion=="total"){
  	  			d3.selectAll("td.exercises").attr("data-sortAs",function(d){return d.values["correct"]+d.values["incorrect"];})
  	  		}else{
		    	d3.selectAll("td.exercises").attr("data-sortAs",function(d){return d.values[sortingCriterion];})
  	  		}
		});
  	  	
  	  	$('table#studentsDashboard').tableSort({
  			animation: 'slide',
  			speed: 1200
  		});
  		
  		
	});

	var json = JSON.parse('{{ jason_data | escapejs }}');
	var students = json.students;
	var assesments=json.assesments;
	var averages=[]
	for (i=0;i<students.length;i++){
		cont=0;
		average=0;
		if(assesments.length > 0){
			for(k=0;k<assesments.length;k++){
				aux=students[i]["assesment"+assesments[k]['id']].grade;
				if(aux=!null){
					average=average+students[i]["assesment"+assesments[k]['id']].grade;
					cont=cont+1;
				}
			}
			average=Math.round((average/cont)*10)/10;
			averages.push(average);
			students[i]['average']=(average);
		}else{
			average='---';
			averages.push(average);
			students[i]['average']=(average);
		}
	}

	//Sort assesments array by their creation date
	assesments.sort(function(a, b) {
    	return parseInt(b.id) - parseInt(a.id);
	});

	var data = [];
	data.push(students);
    // column definitions
    //d3.f is a d3-jetpack function that saves code writing by replacing a line of code -> d3.f("name") = function(d){return d.name}
    var columns = [
        { head: 'Estudiantes', cl: 'name', html: d3.f('name'), type:'text'},
        { head: 'Recomend. completadas', cl: 'recommendations', values: d3.f('recommendations'), type:'numeric'},
        { head: 'Ejercicios desarrollados', cl: 'exercises', values: d3.f('exercises') , type:'numeric'},
        { head: 'Tiempo en ejercicios', cl: 'skills_time', value: d3.f('skills_time'), valueF : d3.f('skills_time',length()) , type:'numeric'},
        { head: 'Tiempo en videos', cl: 'videos_time', valueF: d3.f('video_time', length()), value: d3.f('video_time') , type:'numeric'},
        { head: 'Habilidades', cl: 'skills_level', values: d3.f('skills_level'), type:'numeric'},
        //{ head: 'Evaluacion1', cl: 'assesment', id: 'tooltip', tooltip: '{% for assesment_config in assesment_configs %}{{ "Nombre: " }}{{ assesment_config.name }}{{ "<hr style=margin: 0>% aprobacion: " }}{{ assesment_config.approval_percentage }}{{ "<hr style=margin: 0>Puntaje maximo: " }}{{ assesment_config.top_score }}{% endfor %}', value: d3.f('evaluacion')}//, html: d3.f('evaluacion') },
    ];

    columns.push({head: 'Promedio', cl: 'averages', value: d3.f('averages'), html: d3.f('average'), type:'numeric'})
    //data.push(assesments[0]["assesment_student"]);

    for (i=0; i<json["assesments"].length; i++){
    	var class_id="assesment"+json["assesments"][i]["id"];
    	columns.push({head_assesment: json["assesments"][i]["name"], column: i, cl: class_id, value: d3.f(class_id), type:'numeric'})//html: d3.f('evaluacion')})
    	data.push(assesments[i]["assesment_student"]);
    	var index = i+1;
    	for (var j=0;j<data[i+1].length;j++){
    		var cumulativeStudent=students[j];
    		var assesmentStudent=data[index][j];
	    	data[index][j]=$.extend({},cumulativeStudent,assesmentStudent);
	    }
    }
    
    var selectedAssesment=false;
    var lastIdSelectedAssesment=0;
    //for (i in data){ console.log(data[i])}
	var barWidth, chart, chartInset, degToRad, repaintGauge,
	    height, margin, numSections, padRad, percToDeg, percToRad, 
	    percent, radius, sectionIndx, svg, totalPercent, width;

    percent = .75;
	numSections = 1;
	sectionPerc = 1 / numSections / 2;
	padRad = 0.025;
	chartInset = 10;
	
	// Orientation of gauge:
	totalPercent = .75;
	
	el = d3.select('.chart-gauge');
	
	/*margin = {
	  top: 20,
	  right: 20,
	  bottom: 30,
	  left: 20
	};*/
	
	width = 200;//el[0][0].offsetWidth - margin.left - margin.right;
	height = 50;
	radius = Math.min(width, height) / 2;
	barWidth = 40 * width / 300;
	
	var arc1_array = new Array();
	
	//d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
	var arc2_array = new Array();
	//d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
	var d3_needles = new Array();
 // create table
    var table = d3.select('body')
    	.append('div')
    	.attr('class', 'contained-and-centered')
    	.append('div')
    	.attr('align', 'center')
        .append('table')
        .attr('id','studentsDashboard')
        .style('width', '99%');
        
    table.append('caption').text('{% for class in classroom %}{{ class.level }} {{ class.letter }}').text(' Nueva Evaluación{% endfor %}')

    // create table header
    table.append('thead').append('tr')
        .selectAll('th')
        .data(columns).enter()
        .append('th')
        .attr('class', d3.f('cl'))
        .attr('id', d3.f('id'))
        .attr('title', d3.f('tooltip'))
        .attr('data-sortBy', d3.f('type'))
        .style('height', '100px')
        .text(d3.f('head'));
    
    table.select('th.name').append('div')
    		.attr("class","sort-div")
    		.html(function (d){ return `<div class="arrow-up name" name="`+d.cl+`"></div>
	  		   <div class="arrow-down name" name="`+d.cl+`"></div>`});
    	
    $(".arrow-up.name").attr("column",function(){
        return $("th.name").index();
    });
    $(".arrow-down.name").attr("column",function(){
        return $("th.name").index();
    });
    
    table.select('th.skills_time').append('div')
		.attr("class","sort-div")
		.html(function (d){ return `<div class="arrow-up skills_time" name="`+d.cl+`"></div>
  		   <div class="arrow-down skills_time" name="`+d.cl+`"></div>`});
	
	$(".arrow-up.skills_time").attr("column",function(){
    	return $("th.skills_time").index();
    });
    $(".arrow-down.skills_time").attr("column",function(){
        return $("th.skills_time").index();
    });

	table.select('th.videos_time').append('div')
		.attr("class","sort-div")
		.html(function (d){ return `<div class="arrow-up videos_time" name="`+d.cl+`"></div>
  		   <div class="arrow-down videos_time" name="`+d.cl+`"></div>`});
	
	$(".arrow-up.videos_time").attr("column",function(){
    	return $("th.videos_time").index();
    });
    $(".arrow-down.videos_time").attr("column",function(){
        return $("th.videos_time").index();
    });

    table.select('th.recommendations').append('div')
    		.attr("class","sort-div")
    		.html(function (d){ return `<div class="arrow-up recommendations" name="`+d.cl+`"></div>
	  		   <div class="arrow-down recommendations" name="`+d.cl+`"></div>`});
    	
    $(".arrow-up.recommendations").attr("column",function(){
        return $("th.recommendations").index();
    });
    $(".arrow-down.recommendations").attr("column",function(){
        return $("th.recommendations").index();
    });
    
    table.select('th.exercises').append('div')
		.attr("class","sort-div")
		.html(function (d){ return `
			   <label class="sort-filter">Ordenar por: </label>
	    	   <div class="arrow-up exercises" name="`+d.cl+`"></div>
		  	   <div class="arrow-down exercises" name="`+d.cl+`"></div>
		  	 	<select class="exercises" name="`+d.cl+`">
	  		   		<option value="total">Total</option>
					<option value="correct">Correctos</option>
					<option value="incorrect">Incorrectos</option>
		  		</select>
			  	`});
    $(".arrow-up.exercises").attr("column",function(){
		return $("th.exercises").index();
	});
    $(".arrow-down.exercises").attr("column",function(){
    	return $("th.exercises").index();
	});
    
    table.select('th.skills_level').append('div')
		.attr("class","sort-div")
		.html(function (d){ return `
			   <label class="sort-filter">Ordenar por: </label>
	    	   <div class="arrow-up skills_level" name="`+d.cl+`"></div>
		  	   <div class="arrow-down skills_level" name="`+d.cl+`"></div>
	  		   <select class="skills_level" name="`+d.cl+`">
	  		   		<option value="total">Total</option>
					<option value="mastery3">Dominado</option>
					<option value="mastery2">Nivel 2</option>
					<option value="mastery1">Nivel 1</option>
					<option value="practiced">Practicado</option>
					<option value="struggling">En dificultad</option>
			  	</select>
			  	`});
    $(".arrow-up.skills_level").attr("column",function(){
		return $("th.skills_level").index();
	});
    $(".arrow-down.skills_level").attr("column",function(){
    	return $("th.skills_level").index();
	});
    var isT = false;
    {% if isTeacher %}
	 	isT = true;
	{% endif %}
    var endDates = [];
    for (i=0; i<json["assesments"].length; i++){
    	var class_id="assesment"+json["assesments"][i]["id"];
    	var number_class_id=json["assesments"][i]["id"];
    	var todayDate = new Date();
    	endDate = new Date(Date.parse(json["assesments"][i]["end_date"]))
    	endDate = endDate.getTime() + 97200000
    	endDate = new Date(endDate)
    	if (todayDate<endDate && isT){
    		table.select('th.'+class_id)
    		.append('div')
    		.attr('class',"buttonsES")
    		.html('<button type="button" class="editButton" title="Editar" onClick="isEvaluation('+number_class_id+')"></button><button type="button" class="summaryButton" title="Resumen" onClick="resumenAssesment('+number_class_id+')"></button>')

			endDates.push(endDate)
    		   		
    		table.select('th.'+class_id)
    		.append('span')
    		.attr("class","counter")
    		.attr("id","cntdwn"+i);

    		table.select('th.'+class_id)
    		.append('div')
    		.attr("class","ribbon")
    		.attr("id","ribbon"+i).html("<span>En Curso</span>");

    		
    	}
    	else if (todayDate<endDate){
    		table.select('th.'+class_id)
    		.append('div')
    		.attr('class',"buttonsES")
    		.html('<button type="button" class="showButton" title="Ver Evaluación" onClick="showEvaluation('+number_class_id+')"><button type="button" class="summaryButton" title="Resumen" onClick="resumenAssesment('+number_class_id+')"></button>')

			endDates.push(endDate)
    		   		
    		table.select('th.'+class_id)
    		.append('span')
    		.attr("class","counter")
    		.attr("id","cntdwn"+i);

    		table.select('th.'+class_id)
    		.append('div')
    		.attr("class","ribbon")
    		.attr("id","ribbon"+i).html("<span>En Curso</span>");	
    	}
    	else{
    		table.select('th.'+class_id)
    		.append('div')
    		.attr('class',"buttonsES")
    		.html('<button type="button" class="showButton" title="Ver Evaluación" onClick="showEvaluation('+number_class_id+')"><button type="button" class="summaryButton" title="Resumen" onClick="resumenAssesment('+number_class_id+')"></button>')
	
    	}
  	
    	table.select('th.'+class_id)
    		.append('button')
    		.attr("id",class_id)
    		.attr("class","assesment kui-button-plain kui-button kui-button-primary assesmentButton")
    		.attr('onclick',function(d) { return 'changeData('+d.column+',"'+d.cl+'")' }).text(d3.f('head_assesment'));
    	
    	table.select('th.'+class_id).append('div')
    		.attr("class","sort-div-filter")
    		.html(function (d){ return `
		  		    <label class="sort-filter">Ordenar por: </label>
		    		<div class="arrow-up assesment" name="`+d.cl+`"></div>
	    	  		<div class="arrow-down assesment" name="`+d.cl+`"></div>
    				<select class="assesment" name="`+d.cl+`">
 						<option value="grade">Nota</option>
						<option value="effort">Esfuerzo</option>
				  	</select>
				 	`});   	   	
    }	 
    
    $(".arrow-up.assesment").attr("column",function(){
		var assesment_name = $(this).attr("name");
		return $("th."+assesment_name).index();

	});
	$(".arrow-down.assesment").attr("column",function(d){
		var assesment_name = $(this).attr("name");
		return $("th."+assesment_name).index();
	});
    
    table.select('th.averages').append('div')
    		.attr("class","sort-div")
    		.html(function (d){ return `<div class="arrow-up averages" averages="`+d.cl+`"></div>
	  		   <div class="arrow-down averages" averages="`+d.cl+`"></div>`});
    	
    $(".arrow-up.averages").attr("column",function(){
        return $("th.averages").index();
    });
    $(".arrow-down.averages").attr("column",function(){
        return $("th.averages").index();
    });


    var dataIndex = 0;
    var backgroundJobs = data[dataIndex];
    
	////////////// ESCALAR TIEMPOS SKILLS Y VIDEOS //////
    
	function Greatest(data){
    	greaterThan=0;
    	for (i=0; i<data.length; i++){
	    		if (data[i]>greaterThan){
	    			greaterThan = parseInt(data[i]);
	    		}
    	}
    	return greaterThan
    };
	
    var skill_time=new Array();
    skill_time = d3.map(backgroundJobs, function(d){return d.skills_time;}); //d3.f("skills_time"));
    //console.log(skill_time);
    var skillsTimeScaling = d3.scale.linear()
                        .domain([0,Greatest(skill_time.keys())])
                        .range([0,120]);
                        
    var videos_time = (d3.map(backgroundJobs, function(d) { return d.video_time }));
    var escalarTiemposVideo = d3.scale.linear()
                        .domain([0,Greatest(videos_time.keys())])
                        .range([0,120]);
    
    var corrects = d3.map(backgroundJobs, function(d) { return d3.max([d.exercises["correct"],d.exercises["incorrect"]]);});
    corrects= corrects.keys().map(function(d){
    	return parseInt(d);
    })
    var escalarCorrectIncorrect = d3.scale.linear()
                        .domain([0,d3.max(corrects)])
                        .range([0,60]);
    ///////////////////////////////////////////////////
    
    
    var changeData = function (dataIndex , assesment) {

 		var idSelectedAssesment=dataIndex+1;
    	if (!selectedAssesment){ // Seleccionando una evaluación
    		$(".assesment kui-button-plain kui-button kui-button-primary assesmentButton").css("background-color","");
    		$("#"+assesment).addClass("selected");
    		$(".selected").css("background-color","rgba(86,134,31,0.15)");
    		$("#"+assesment).removeClass("selected");
    		$("#"+assesment).blur();
	    	backgroundJobs = data[dataIndex+1];
	    	selectedAssesment=true;
	    	lastIdSelectedAssesment=idSelectedAssesment;
	    	lastClassSelectedAssesment=assesment;
	    	//Filters every circle that is not from the clicked assesment and show them almost transparent
	    	tbody.selectAll("circle:not(."+assesment+")")
	    		.filter(".assesment")
	    		.transition()
	    		.duration(750)
	    		.style("opacity",0.15);
	    	tbody.selectAll("text:not(."+assesment+")")
	    		.filter(".assesment")
	    		.transition()
	    		.duration(750)
	    		.style("opacity",function(d){
	    			var color = d3.rgb(d3.select(this).style("fill")).toString();
	    			if (color=="#ffffff"){
	    				return 1;
	    			}else{
	    				return 0.15;
	    			}
	    		});
	    	//Disable other assesment buttons
	    	//$("button.assesment").filter(":not(#"+assesment+")").prop("disabled",true);
	    	//$("button.assesment").filter(":not(#"+assesment+")").css("pointer-events","none");
	    	//$("button.assesment").filter(":not(#"+assesment+")").fadeTo(750,0.1);
    	}else{
    		
    		if (idSelectedAssesment==lastIdSelectedAssesment){ // Deseleccionando todas las evaluaciones
    			$(".assesment kui-button-plain kui-button kui-button-primary assesmentButton").css("background-color","");
    			$("#"+assesment).blur();
    			backgroundJobs = data[0];
        		selectedAssesment=false;
        		lastIdSelectedAssesment=0;
        		tbody.selectAll("circle:not(."+assesment+")")
		    		.filter(".assesment")
		    		.transition()
		    		.duration(750)
		    		.style("opacity",1);
		    	tbody.selectAll("text:not(."+assesment+")")
		    		.filter(".assesment")
		    		.transition()
		    		.duration(750)
		    		.style("opacity",1);
		    	$("button").css("background-color","");
    		}else{ // Cambiando la evaluación seleccionada por otra
    			$("#"+lastClassSelectedAssesment).css("background-color","");
    			$("#"+assesment).blur();
    			$("#"+assesment).addClass("selected");
	    		$(".selected").css("background-color","rgba(86,134,31,0.15)");
	    		$("#"+assesment).removeClass("selected");
    			backgroundJobs = data[dataIndex+1];
		    	selectedAssesment=true;
		    	//Selected assesment comes back to having opacity 1
		    	tbody.selectAll("circle."+assesment)
		    		.transition()
		    		.duration(750)
		    		.style("opacity",1);
		    	tbody.selectAll("text."+assesment)
		    		.transition()
		    		.duration(750)
		    		.style("opacity",1);
		    	//Filters every circle that is not from the clicked assesment and show them almost transparent
		    	tbody.selectAll("circle:not(."+assesment+")")
		    		.filter(".assesment")
		    		.transition()
		    		.duration(750)
		    		.style("opacity",0.15);
		    	tbody.selectAll("text:not(."+assesment+")")
		    		.filter(".assesment")
		    		.transition()
		    		.duration(750)
		    		.style("opacity",function(d){
	    			var color = d3.rgb(d3.select(this).style("fill")).toString();
		    		if (color=="#ffffff"){
		    			return 1;
		    		}else{
		    			return 0.15;
		    		}
		    	});
		    	lastIdSelectedAssesment=idSelectedAssesment;
		    	lastClassSelectedAssesment=assesment;
    		}
    		//Enable back other assesment buttons
    		//$("button.assesment").filter(":not(#"+assesment+")").prop("disabled",false);
    		//$("button.assesment").filter(":not(#"+assesment+")").css("pointer-events","initial");
    		//$("button.assesment").filter(":not(#"+assesment+")").fadeTo(750,1);
    	}
    	skill_time = d3.map(backgroundJobs, function(d){return d.skills_time;}); //d3.f("skills_time"));
	    skillsTimeScaling = d3.scale.linear()
                            .domain([0,Greatest(skill_time.keys())])
                            .range([0,120]);
	    videos_time = (d3.map(backgroundJobs, function(d) { return d.video_time }));
        escalarTiemposVideo = d3.scale.linear()
                            .domain([0,Greatest(videos_time.keys())])
                            .range([0,120]);
        corrects = d3.map(backgroundJobs, function(d) { return d3.max([d.exercises["correct"],d.exercises["incorrect"]]);});
        corrects= corrects.keys().map(function(d){
        	return parseInt(d);
        })
        escalarCorrectIncorrect = d3.scale.linear()
                            .domain([0,d3.max(corrects)])
                            .range([0,60]);
        skill_levels_scaling=d3.scale.linear()
			.domain([0,d3.max(backgroundJobs,function(d){
				var total_skills=0;
					total_skills=total_skills+d.skills_level.struggling;
					total_skills=total_skills+d.skills_level.practiced;
					total_skills=total_skills+d.skills_level.mastery1;
					total_skills=total_skills+d.skills_level.mastery2;
					total_skills=total_skills+d.skills_level.mastery3;
					return total_skills;
				})])
				.range([0,120]);
        
        tick_update();
    }
    

    /////////// escala de skill_levels de jordan y tu
    var skill_levels_scaling=d3.scale.linear()
	.domain([0,d3.max(students,function(d){
		var total_skills=0;
			total_skills=total_skills+d.skills_level.struggling;
			total_skills=total_skills+d.skills_level.practiced;
			total_skills=total_skills+d.skills_level.mastery1;
			total_skills=total_skills+d.skills_level.mastery2;
			total_skills=total_skills+d.skills_level.mastery3;
			return total_skills;
		})])
		.range([0,120]);

	//skills_level_colors = ["#9CDCEB", "#58C4DD", "#29ABCA", "#1C758A"];
	skills_level_colors = ["#C30202","#9CDCEB", "#58C4DD", "#29ABCA", "#1C758A"];
	
	
	var reprobateColors = ["#C30202", "#FB6060"];
    //var approveColors = ["#9CDCEB", "#58C4DD", "#29ABCA", "#1C758A"];
   	var approveColors = ["#9CDCEB", "#1C758A"];
   	var reprobateColor = [];
   	var approveColor =[];
    /*var reprobateColor = d3.scale.linear()
	  .domain([2, 3.9])//, 1.9 / (reprobateColors.length - 1)))
	  .range(reprobateColors);
		var approveColor = d3.scale.linear()
	  .domain([4.0,7.0])//d3.range(4,7, 3.0 / (approveColors.length - 1)))
	  .range(approveColors);*/

    
	/////////////// parte principal para dibujar la tabla //////////////////////////////  
	table.append('tbody');
    
    var tbody = d3.select('tbody');

    function tick() {
    	
        var rows = tbody.selectAll("tr")
    	.data(backgroundJobs, function(d) {
    	    return d.name;
    	});

    	rows.enter()
    		.append("tr");
    	//rows.transition().sort(function (a, b) { return a == null || b == null ? 0 : stringCompare(a[attrName], b[attrName]); });
        
        //rows.order();

        var cells = rows.selectAll("td")
    		.data(function(row,i) {
    			return columns.map(function(c) {
	                // compute cell values for this specific row
	                var cell = {};
	                d3.keys(c).forEach(function(k) {
	                    cell[k] = typeof c[k] == 'function' ? c[k](row,i) : c[k];
	                });
	                return cell;
    			});
    		});

    	cells.enter()
    		.append("td").html(d3.f('html'))
	        .attr('class', d3.f('cl'))
	        .attr('id', d3.f('id'));
    	
    	cells.text(function(d) { return d.html;});
    	
    	drawRecommendations();
    	drawSkillTime();
    	drawVideoTime();
    	drawCorrectIncorrect();
    	drawSkillLevels();
    	drawAssesments();
    	
    	cells.exit().remove();
    	rows.exit().remove();
    }
    
	function tick_update() {
    	
    	//console.log(backgroundJobs);
        var rows = tbody.selectAll("tr")
    	.data(backgroundJobs, function(d) {
    	    return d.name;
    	});

    	/*rows.enter()
    		.append("tr");
        
        rows.order();*/

        var cells = rows.selectAll("td")
    		.data(function(row,i) {
    			return columns.map(function(c) {
	                // compute cell values for this specific row
	                /*console.log("c");
	                console.log(c);*/
	                var cell = {};
	                d3.keys(c).forEach(function(k) {
	                    cell[k] = typeof c[k] == 'function' ? c[k](row,i) : c[k];
	                });
	                return cell;
    			});
    		});
       
       cells.select("svg");
       svg=tbody.selectAll("svg");
       
       //Update data of skills time d3 elements
       svg.select("rect.skills_time");
       svg.select("text.skills_time");
       
       //Update data of videos time d3 elements
       svg.select("rect.videos_time");
       svg.select("text.videos_time");
       
       //Update data of exercises d3 elements (incorrects and corrects)
       svg.select("rect.incorrect");
       svg.select("text.incorrect");
       svg.select("rect.correct");
       svg.select("text.correct");
       
       //Update data of skill level d3 bars
       //svg.select("rect.skills_level");
       
	   //Update data of g where d3 gauge of rec completed are drawn
	   svg.select("g.recommendations");
        
    	drawSkillTimeUpdate();
    	drawVideoTimeUpdate();
    	drawCorrectIncorrectUpdate();
    	drawSkillLevelsUpdate();
    	drawRecommendationsUpdate();
    	//drawAssesments();
    	
    	//cells.exit().remove();
    	//rows.exit().remove();
    }
    
    /////////////// Functions to draw the d3 graphs on the table /////////////////////
    
    function drawSkillTime(){
	    var tiempos_skill = tbody.selectAll('.skills_time')
	    	.append("svg")
	    	.attr("class","skills_time")
	    	.attr("width","120")
	    	.attr("height","30");
	    tiempos_skill
	    	.append("rect")
	    	.attr("class","skills_time")
	    	.attr("y",12)
	    	.style("fill","#1C758A")
	    	//.style("fill","#FC8A3B")
	    	.attr("width","0").transition().duration(750)
	    	.attr("width",function(d){return skillsTimeScaling(d.value)})
	    	.attr("height","15");
	    
	    tiempos_skill
	    	.append("text")
	    	.attr("class","skills_time")
		    .attr("x", 0)//function(d) { return skillsTimeScaling(d.value)+2 })
		    .attr("y", 5)
		    .attr("dy", ".35em")
			.attr("fill", "black")
		    .text(function(d) { return d.valueF });
    }
    
    function drawSkillTimeUpdate(){
	    var skills_time_bars = tbody.selectAll('.skills_time rect')
	    	.transition().duration(750)
	    	.attr("width",function(d){return skillsTimeScaling(d.value)});
	    skills_time_texts = tbody.selectAll('.skills_time text')
	    	.transition().duration(750)
		    //.attr("x", function(d) { return skillsTimeScaling(d.value)+2 })
		    .text(function(d) { return d.valueF });
	    }
    
    function drawVideoTime(){
	    var tiempos_video = tbody.selectAll(".videos_time")
	    	.append("svg")
	    	.attr("class","videos_time")
	    	.attr("width","120")
	    	.attr("height","30")
	    tiempos_video
	    	.append("rect")
	    	.attr("class","videos_time")
	    	.attr("y",12)
	    	.style("fill","#1C758A")
	    	.attr("height","15")
	    	.attr("width","0").transition().duration(750)
	    	.attr("width",function(d){return escalarTiemposVideo(d.value)});
	    
	    tiempos_video
	    	.append("text")
	    	.attr("class","videos_time")
		    .attr("x", 0 )//function(d) { return escalarTiemposVideo(d.value)+5; })
		    .attr("y", 5)
		    .attr("dy", ".35em")
			.attr("fill", "black")
		    .text(function(d) { return d.valueF });
    }
    
    function drawVideoTimeUpdate(){
    	var video_times_bars = tbody.selectAll('.videos_time rect')
			.transition().duration(750)
    		.attr("width",function(d){return escalarTiemposVideo(d.value)});
    	var video_times_texts = tbody.selectAll('.videos_time text')
    		.transition().duration(750)
    		//.attr("x", function(d) { return escalarTiemposVideo(d.value)+5; })
    		.text(function(d) { return d.valueF });

	}
    
    function drawCorrectIncorrect(){
	    var correct_incorrect = tbody.selectAll(".exercises")
	    	.append("svg")
	    	.attr("class","exercises")
	    	.attr("width","120")
	    	.attr("height","30");
	    
	    var incorrectos = correct_incorrect.append("rect")
	    	  .attr("class","incorrect")
	    	  .attr("height","15")
	    	  .attr("x",60)
	    	  .attr("y",12)
	    	  .transition().duration(750)
	    	  //.attr("x", function(d) { console.log(d);return 60-escalarCorrectIncorrect(d.values["incorrect"]); })
		      .attr("x", function(d) { return 60-escalarCorrectIncorrect(d.values["incorrect"]); })
		      .attr("width", function(d){return escalarCorrectIncorrect(d.values["incorrect"]); })
	    	  .style("fill","#C30202");

	    correct_incorrect
	    	.append("text")
	    	.attr("class","incorrect")
		    .attr("x", function(d){
		    	return 60;
		    })
		    .attr("y", 5)
		    .attr("dy", ".35em")
			.attr("fill", "black")
		    .text(function(d) { return d.values["incorrect"] });
		correct_incorrect.selectAll("text")
			.attr("transform",function(d){
				var textWidth = d3.select(this).node().getBBox().width;
				return "translate("+(-(textWidth+3))+",0)";
				});
	    var correctos = 
	    	correct_incorrect.append("rect")
	    	.attr("class","correct")
	    	.attr("x",60)
	    	.attr("y",12)
	    	.style("fill","#1C758A")
	    	.attr("width","0").transition().duration(750)
	    	.attr("width",function(d){return escalarCorrectIncorrect(d.values["correct"])})
	    	.attr("height","15");
	    	//.style("fill","#9DB63B");
	    
	    correct_incorrect
	    	.append("text")
	    	.attr("class","correct")
		    .attr("x", 63)//function(d) { return 93+escalarCorrectIncorrect(d.values[0])})
		    .attr("y", 5)
		    .attr("dy", ".35em")
			.attr("fill", "black")
		    .text(function(d) { return d.values["correct"] });
		
		//Sorting by the total of exercises done is default
	  		d3.selectAll("td.exercises").attr("data-sortAs",function(d){return d.values["correct"]+d.values["incorrect"];});
    }
    
    function drawCorrectIncorrectUpdate(){
	    var incorrect_bars = tbody.selectAll("rect.incorrect")
	    	  .transition().duration(750)
	    	  .attr("x", function(d) { return 60-escalarCorrectIncorrect(d.values["incorrect"]); })
		      .attr("width", function(d){return escalarCorrectIncorrect(d.values["incorrect"]); });

	    var incorrect_texts = tbody.selectAll("text.incorrect")//correct_incorrect
	    	.text(function(d) { return d.values["incorrect"] })
		    .transition().duration(750)
	    	.attr("transform",function(d){
				var textWidth = d3.select(this).node().getBBox().width;
				return "translate("+(-(textWidth+3))+",0)";
			});
	    
	    var correct_bars = tbody.selectAll("rect.correct")
	    	.transition().duration(750)
	    	.attr("width",function(d){return escalarCorrectIncorrect(d.values["correct"])})
	    var correct_texts = tbody.selectAll("text.correct")
	    	.transition().duration(750)
		    .text(function(d) { return d.values["correct"] });
	    var sortingCriterion = $("select.exercises").val();
	    //console.log(sortingCriterion);
	  		if (sortingCriterion=="total"){
	  			d3.selectAll("td.exercises").attr("data-sortAs",function(d){return d.values["correct"]+d.values["incorrect"];})
	  		}else{
	    	d3.selectAll("td.exercises").attr("data-sortAs",function(d){return d.values[sortingCriterion];})
	  		}
	}
    
    
    function drawSkillLevels() {
	    var skill_levels = tbody.selectAll(".skills_level")
    	.append("svg")
    	.attr("class","skills_level")
    	.attr("width","120")
    	.attr("height","30");
		
		skill_levels.selectAll('rect')
		      .data(function(d,i){
		    	  var skills_array=[];
		    	  skills_array[0]=d.values.struggling;
		    	  skills_array[1]=d.values.practiced;
		    	  skills_array[2]=d.values.mastery1;
		    	  skills_array[3]=d.values.mastery2;
		    	  skills_array[4]=d.values.mastery3;
		    	  var skills=[]
		    	  for (var j=0;j<skills_array.length;j++){
		    		  var offset=0;
		    		  for (var k=j-1;k>=0;k--){
		    			  offset=offset+skills_array[k];
		    		  }
		    		  skills.push({id_level:j, value: skills_array[j], prev_value: offset});
		    	  }
		    	  return skills;
		      })
		      .enter()
		      .append('rect')
		      .attr("class","skills_level")
		      .attr("id",function(d,i){return i;})
		      .attr('width', function(d){
		          return skill_levels_scaling(d.value);})
		      .attr('x',function(d, i){
		          return skill_levels_scaling(d.prev_value);})
		      .attr('y',12)
		      .attr('height', "20px")
		      .style('fill', function(d, i){ return skills_level_colors[i]; });

		       $("svg.skills_level").tipsy({ 
				        gravity: 'ne',
				        opacity: 1,
				        html: true, 
				        title: function() {
				          var d = this.__data__;
				          tooltp =(`<ul>
				          		<li style='text-align:left;'><strong><font color='#C30202'>En dificultad: </font>`+d.values.struggling+`</li>
				          		<li style='text-align:left;'><font color='#9CDCEB'>Practicado: </font>`+d.values.practiced+`</li>
				          		<li style='text-align:left;'><font color='#58C4DD'>Nivel 1: </font>`+d.values.mastery1+`</li>
				          		<li style='text-align:left;'><font color='#29ABCA'>Nivel 2: </font>`+d.values.mastery2+`</li>
				          		<li style='text-align:left;'><font color='#1C758A'>Dominado: </font>`+d.values.mastery3+`</li>
				          		</strong></ul>`);
				          return tooltp
				        }
				    });
	    
	    d3.selectAll("td.skills_level").attr("data-sortAs",function(d){
  			return d.values["mastery3"]+d.values["mastery2"]+d.values["mastery1"]+d.values["practiced"]+d.values["struggling"];
  		});

  		//d3.selectAll("svg.skills_level")
	    skill_levels
	    	.append("text")
	    	.attr("class","skills_level")
		    .attr("x", 0 )//function(d) { return escalarTiemposVideo(d.value)+5; })
		    .attr("y", 5)
		    .attr("dy", ".35em")
			.attr("fill", "black")
		    .text(function(d) { return d.values["mastery3"]+d.values["mastery2"]+d.values["mastery1"]+d.values["practiced"]+d.values["struggling"]});
	}
	
	function drawSkillLevelsUpdate() {
	    var skill_levels = tbody.selectAll("rect.skills_level")
	    	.each(function(d,i){
	    		var new_data=this.parentNode.__data__;
	    		var id_level = d.id_level;
	    		var skills_array=[];
		    	skills_array[0]=new_data.values.struggling;
		    	skills_array[1]=new_data.values.practiced;
		    	skills_array[2]=new_data.values.mastery1;
		    	skills_array[3]=new_data.values.mastery2;
		    	skills_array[4]=new_data.values.mastery3;
		    	var skills=[];
		    	var offset=0;
		    	for (var j=id_level-1;j>=0;j--){
		    		offset=offset+skills_array[j];
		        }
		    	d.value = skills_array[id_level];
		    	d.prev_value = offset;
	    	});
	    
	    
	    
	    tbody.selectAll("rect.skills_level")
		      .transition().duration(750)
		      .attr('width', function(d){
		          return skill_levels_scaling(d.value);})
		      .attr('x',function(d, i){
		          return skill_levels_scaling(d.prev_value);});

		var skill_levels = tbody.selectAll("svg.skills_level")
			.select("text")
	    	.transition().duration(750)
		    .text(function(d) {
		    	var new_data = new_data=this.parentNode.__data__;
		    	return new_data.values["mastery3"]+new_data.values["mastery2"]+new_data.values["mastery1"]+new_data.values["practiced"]+new_data.values["struggling"]});
		
	    var sortingCriterion = $("select.skills_level").val();
	  		if (sortingCriterion =="total"){
	  			d3.selectAll("td.skills_level").attr("data-sortAs",function(d){
	  				return d.values["mastery3"]+d.values["mastery2"]+d.values["mastery1"]+d.values["practiced"]+d.values["struggling"];
	  			});
	  		}else{
	    	d3.selectAll("td.skills_level").attr("data-sortAs",function(d){return d.values[sortingCriterion];});
	  		}
	
	}
	
	function drawAssesments(){
	//console.log(assesments);
	var effort_scalings = [];
    for (i=0; i<assesments.length; i++){
    	var assesment_num_id=i;
    	var assesment_id="assesment"+json["assesments"][i]["id"]
    	effort_scalings[assesment_id] = d3.scale.log()
    									.domain([d3.min(students,function(d){return d[assesment_id].effort;}),//d3.filter(students,function(d){return d[assesment_id].effort;})),
    										d3.max(students,function(d){return d[assesment_id].effort;})])//d3.filter(students,function(d){return d[assesment_id].effort;}))])
    									.range([10,22.5]);
    	
    	var approval_percentage=assesments[assesment_num_id].approval_percentage;
    	var min_grade=assesments[assesment_num_id].min_grade;
    	var max_grade=assesments[assesment_num_id].max_grade;
    	var approval_grade=assesments[assesment_num_id].approval_grade;
    	//var approval_grade = (max_grade-min_grade)*(approval_percentage/100) + min_grade;
    	reprobateColor[assesment_num_id] = d3.scale.linear()
		  .domain([min_grade, approval_grade])//, 1.9 / (reprobateColors.length - 1)))
		  .range(reprobateColors);
		approveColor[assesment_num_id] = d3.scale.linear()
		  .domain([approval_grade,max_grade])//d3.range(4,7, 3.0 / (approveColors.length - 1)))
		  .range(approveColors);

    	var assesments_svg = tbody.selectAll("td.assesment"+json["assesments"][i]["id"]).attr("class","assesment assesment"+json["assesments"][i]["id"])
	    	.append("svg")
	    	.attr("class","assesment assesment"+json["assesments"][i]["id"])
	    	.attr("width",function(d,i){return 2*effort_scalings[d.cl](students[i][assesment_id].effort);})
    		.attr("height",function(d,i){return 2*effort_scalings[d.cl](students[i][assesment_id].effort);});
		
    	assesments_svg.append("circle")
    		.attr("class","assesment assesment"+json["assesments"][i]["id"])
    		.attr("cx", function (d,i) { return effort_scalings[d.cl](students[i][assesment_id].effort); })
            .attr("cy", function (d,i) { return effort_scalings[d.cl](students[i][assesment_id].effort); })
    		.attr("r",function(d,i){
    			if (students[i][assesment_id].grade==null){
    				return 0;
    			}else{
    				return effort_scalings[d.cl](students[i][assesment_id].effort);
    			}
    		})
    		.attr("id_json",function(d,i){
    			return i;
    		})
    		.style("fill",
    				function(d,i){ 
    					nota = students[i][assesment_id].grade + students[i][assesment_id].bonus_grade + students[i][assesment_id].teacher_grade;
    					if (nota<approval_grade){
    						return reprobateColor[assesment_num_id](nota);
    					}else{
    						return approveColor[assesment_num_id](nota);
    					}
    			  })
    		.on("click",function(d){
    			//console.log(d)
    			$('#popup_nombre').empty();
    			$('#popup_nombre').append("<p id='pgrade' style='margin-top:0px;'><strong>"+d.head_assesment+"</strong></p>");
    			$('#popup_nombre').append("<p id='pgrade' style='margin-top:0px;'><strong>"+d.value.name+"</strong></p>");
    			//$('#popup_nombre').append("<p style='margin-top:0px;'><strong>Nota: </strong>"+d.value.grade+"<strong>    Bonificacion: </strong>"+d.value.bonus_grade+"</p>");
    			$('#input_grade_id').val(eval(d.value.grade_id));
    			$('#textarea_coment').val(d.value.comment);
    			$('#input_grade').val(d.value.grade);
    			$('#input_bonificacion').val(d.value.bonus_grade);
    			$('#input_grade_teacher').val(d.value.teacher_grade);
    			$("#hover").fadeIn().css('display', '');
    			$("#popup").fadeIn().css('display', '');
    		});
    	
    	
    	
    	assesments_svg.append("text")
    		.attr("class","assesment assesment"+json["assesments"][i]["id"])
	        .attr("dx", function(d,i){return effort_scalings[d.cl](students[i][assesment_id].effort);})
	        .attr("dy", function(d,i){return 6 + effort_scalings[d.cl](students[i][assesment_id].effort);})
	        .text(function(d,i){
	        	if (students[i][assesment_id].grade!=null){
	        		nota = students[i][assesment_id].grade + students[i][assesment_id].bonus_grade + students[i][assesment_id].teacher_grade;
	        		nota = Math.round(nota*10)/10;
	        		if (nota>max_grade){
	        			nota = max_grade;
	        			nota = nota+"+";
	        		}
	        		if (students[i][assesment_id].teacher_grade!=0){
	        			nota = nota+" *";
	        		}
	        		return nota;
	        	}else{
	        		return "S.E.";
	        	}
	        })
	        .style("fill",function(d,i){
	        	if (students[i][assesment_id].grade!=null){
	        		return "white";
	        	}else{
	        		return "black";
	        	}
	        })
	        .style("pointer-events","none");
	    	
    	
    	assesments_svg.selectAll("text")
    		.attr("transform",function(d){
    			var textWidth = d3.select(this).node().getBBox().width;
				return "translate("+(-(textWidth/2))+",0)";
    	});
	    	
	    $("circle."+assesment_id).tipsy({ 
	        gravity: 'ne',
	        opacity: 1,
	        html: true, 
	        title: function() {
	          var d = this.__data__;
	          var id_json_student = $(this).attr("id_json");
	          var id_json_assesment = d.column;
	          var student_data = json["assesments"][id_json_assesment]["assesment_student"][id_json_student];
	          var skills_time = student_data.skills_time;
	          var mins_skills_time = ~~(skills_time / 60);
	          var secs_skills_time = skills_time % 60;
	          var video_time = student_data.video_time;
	          var mins_video_time = ~~(video_time / 60);
	          var secs_video_time = video_time % 60;
	          var bonus_grade = d.value.bonus_grade;
	          var teacher_grade = d.value.teacher_grade;
	          var grade = d.value.grade;
	          var skl = `<li style='text-align:left;'><strong>Habilidades: </strong></li>`
	          for (i=0;i<(d.value.skills).length;i++){
	          	//alert(d.value.skills[i][1]);
	          	skl = skl + `<li style='text-align:left;'><div><IMG style='width:13px;height:13px;margin-right:5px' SRC='{% static 'img/check.svg'%}'>`+d.value.skills[i][0] 
	          	skl = skl + ` <font color="#1C758A">C: `+d.value.skills[i][4]+`</font><font color="#C30202"> I: `+d.value.skills[i][3]+`</font></li>`  
	          };
	          var algo = `<li>Nota ficticia: `+5+`</li>`
	          tooltp =(`<ul>
	          		<li style='text-align:left;'>Nota por Desempeño:`+grade+`</li>
	          		<li style='text-align:left;'>Bonificacion por Esfuerzo:`+bonus_grade+`</li>
	          		<li style='text-align:left;'>Bonificacion del Profesor:`+teacher_grade+`</li>
	          		`+skl+`
	          		</ul>`);
	          return tooltp
	        }
	      });
	    /*
		   lo que habia antes en el tipsy
		   <li>% de recomend. completadas: `+Math.round((student_data.recommendations.completed_perc)*100)+`</li>
	       <li>Ejercicios incorrectos:`+student_data.exercises.incorrect+`</li>
	       <li>Ejercicios correctos: `+student_data.exercises.correct+`</li>
	       <li>Tiempo en ejercicios: `+mins_skills_time+`:`+secs_skills_time+` minutos</li>
	       <li>Tiempo en videos: `+mins_video_time+`:`+secs_video_time+` minutos</li>
	       <li>Hab. dominadas: `+student_data.skills_level.mastery3+`</li>
	       <li>Hab. nivel 2: `+student_data.skills_level.mastery2+`</li>
	       <li>Hab. nivel 1: `+student_data.skills_level.mastery1+`</li>
	       <li>Hab. practicadas: `+student_data.skills_level.practiced+`</li>
	       <li>Hab. en dificultad: `+student_data.skills_level.struggling+`</li>
	    */
	        
    }
	}
	
	function percToDeg(perc) {
	    return perc * 360;
	};

	function percToRad(perc) {
	    return degToRad(percToDeg(perc));
	};

	function degToRad(deg) {
	    return deg * Math.PI / 180;
	};

	
	/////////////// dibujar al principio ///////////////////
    tick();
    
	
	//Funciones para dibujar el recommendations gauge //
    function length() {
        var fmt = d3.format('02d');
        return function(l) { return Math.floor(l / 60) + ':' + fmt(l % 60) + ''; };
    }
	
    function drawRecommendations(){
    	tbody.selectAll("td.recommendations").attr("data-sortAs",function(d){return d.values.completed_perc;});
    	var recommendations = tbody.selectAll('.recommendations')
    							.append("svg")
    							.attr("class","recommendations")
    							.attr("width","80")
    							.attr("height",height);
    	var g_rec = recommendations.append('g').attr("class","recommendations")
    		.attr('transform', "translate(" + 40 + ", " + (height-5) + ")")
    		.attr("id_student",function(d,i){
    			return i;
    		});
    	/*g_rec.each(function(d,i){
    		arc1_array[i]=d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
    		arc2_array[i]=d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
    	})*/
    	g_rec.append('svg:path').attr('class', "arc chart-filled").attr("id",function(d,i){return "chart-filled"+i;});/*.attr('d', function(d){
	    	var next_start = totalPercent;
	    	var perc = 40;
	    	arcStartRad = percToRad(next_start);
	    	arcEndRad = arcStartRad + percToRad(perc / 2);
	    	next_start += perc / 2;

	  	    var arc1 = d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
	  	    arc1.startAngle(arcStartRad).endAngle(arcEndRad);
	  	    console.log(arc1);
    		return arc1;});*/
    	g_rec.append('svg:path').attr('class', "arc chart-empty").attr("id",function(d,i){return "chart-empty"+i;});/*.attr('d', function(d){
    		
    	});*/
    	//g_rec.append
    	
    	
    	//var gRecNeedleCenter = tbody.selectAll("g.recommendations").append('circle').attr('class', 'needle-center').attr('cx', 0).attr('cy', 0).attr('r', 5);
    	//var gRecNeedle =tbody.selectAll("g.recommendations").append('path').attr('class', 'needle').attr('d', recalcPointerPos(50,5,34));
    	
    	//var g_rec_array = g_rec
    	g_rec.each(function(d,i){
	    		//console.log("i: "+i+" reco:"+d.values.completed_perc);
	    		var completed_perc = d.values.completed_perc;
	    		var next_start = totalPercent;
			    arcStartRad = percToRad(next_start);
			    arcEndRad = arcStartRad + percToRad(completed_perc / 2);
			    next_start += completed_perc / 2;
    			//arc1_array.push(d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)
    			arc1_array.push(d3.svg.arc().outerRadius(35).innerRadius(20)
    				.startAngle(arcStartRad)
    				.endAngle(arcEndRad));
    			arcStartRad = percToRad(next_start);
  		      	arcEndRad = arcStartRad + percToRad((1 - completed_perc) / 2);
    			arc2_array.push(d3.svg.arc().outerRadius(35).innerRadius(20)//radius - chartInset).innerRadius(radius - chartInset - barWidth)
    					.startAngle(arcStartRad + padRad)
    					.endAngle(arcEndRad));
    			d3.select("#chart-filled"+i).transition().delay(300).ease('bounce').duration(1500).attr("d",arc1_array[i]);
    			d3.select("#chart-empty"+i).transition().delay(300).ease('bounce').duration(1500).attr("d",arc2_array[i]);
    			d3.select(this).append("text")
    				.html(Math.round(completed_perc*100)+"%")
    				.attr("transform",function(d){
    					var textWidth = d3.select(this).node().getBBox().width;
    					return "translate("+(-(textWidth/2))+",-22)";
    				})
    				.attr("fill",function(d){
    					if (completed_perc>0.4){
    						return "white"; 
    					}else{
    						return "black";
    					}
    				});
    			var d3_needle = new Needle(d3.select(this),i);
    			d3_needle.render();
    			d3_needle.moveTo(completed_perc);
	    		d3_needles.push(d3_needle);
    		});

 		
    }
	
    function drawRecommendationsUpdate2(){
    	var g_rec = tbody.selectAll('g.recommendations');
    	g_rec.each(function(d,i){
    		var completed_perc = d.values.completed_perc;
    		var next_start = totalPercent;
		    arcStartRad = percToRad(next_start);
		    arcEndRad = arcStartRad + percToRad(completed_perc / 2);
		    next_start += completed_perc / 2;
    			arc1_array[i]
    				.startAngle(arcStartRad)
    				.endAngle(arcEndRad);
    			arcStartRad = percToRad(next_start);
  		      	arcEndRad = arcStartRad + percToRad((1 - completed_perc) / 2);
    			arc2_array[i]
    					.startAngle(arcStartRad + padRad)
    					.endAngle(arcEndRad);
    			d3.select("#chart-filled"+i).transition().delay(300).ease('bounce').duration(1500).attr("d",arc1_array[i]);
    			d3.select("#chart-empty"+i).transition().delay(300).ease('bounce').duration(1500).attr("d",arc2_array[i]);
    			d3_needles[i].moveTo(completed_perc);
    		});

 		
    }
    
    function drawRecommendationsUpdate(){
    	var g_rec = tbody.selectAll('g.recommendations');
    	g_rec.each(function(d,i){
    		var completed_perc = d.values.completed_perc;
    		var id_needle = d3.select(this).attr("id_student");
    		d3_needles[id_needle].moveTo(completed_perc);
    		d3.select(this).select("text")
				.html(Math.round(completed_perc*100)+"%")
				.attr("transform",function(d){
					var textWidth = d3.select(this).node().getBBox().width;
					return "translate("+(-(textWidth/2))+",-22)";
				})
				.attr("fill",function(d){
					if (completed_perc>0.4){
						return "white"; 
					}else{
						return "black";
					}
				});
    	});
		//console.log(tbody.selectAll("td.recommendations"));
    	tbody.selectAll("td.recommendations").attr("data-sortAs",function(d){return d.values.completed_perc;});
    }

    function recalcPointerPos(len,radius,perc) {
          var centerX, centerY, leftX, leftY, rightX, rightY, thetaRad, topX, topY;
          thetaRad = percToRad(perc / 2);
          centerX = 0;
          centerY = 0;
          topX = centerX - len * Math.cos(thetaRad);
          topY = centerY - len * Math.sin(thetaRad);
          leftX = centerX - radius * Math.cos(thetaRad - Math.PI / 2);
          leftY = centerY - radius * Math.sin(thetaRad - Math.PI / 2);
          rightX = centerX - radius * Math.cos(thetaRad + Math.PI / 2);
          rightY = centerY - radius * Math.sin(thetaRad + Math.PI / 2);
          return "M " + leftX + " " + leftY + " L " + topX + " " + topY + " L " + rightX + " " + rightY;
    }
    
    var repaintGauge = function(perc,i) 
    {
    	var completed_perc = perc
		var next_start = totalPercent;
	    arcStartRad = percToRad(next_start);
	    arcEndRad = arcStartRad + percToRad(completed_perc / 2);
	    next_start += completed_perc / 2;
			//arc1_array.push(d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)
			arc1_array[i]
				.startAngle(arcStartRad)
				.endAngle(arcEndRad);
			arcStartRad = percToRad(next_start);
		      	arcEndRad = arcStartRad + percToRad((1 - completed_perc) / 2);
			arc2_array[i]//.push(d3.svg.arc().outerRadius(50).innerRadius(30)//radius - chartInset).innerRadius(radius - chartInset - barWidth)
					.startAngle(arcStartRad + padRad)
					.endAngle(arcEndRad);
			d3.select("#chart-filled"+i).attr("d",arc1_array[i]);
			d3.select("#chart-empty"+i).attr("d",arc2_array[i]);
    }

    function percentile(arr, p) {
	    if (arr.length === 0) return 0;
	    if (typeof p !== 'number') throw new TypeError('p must be a number');
	    if (p <= 0) return arr[0];
	    if (p >= 1) return arr[arr.length - 1];

	    var index = arr.length * p,
	        lower = Math.floor(index),
	        upper = lower + 1,
	        weight = index % 1;

	    if (upper >= arr.length) return arr[lower];
	    return arr[lower]; //* (1 - weight) + arr[upper] * weight;
	}

    function drawSkillsBoxPlot(skill_levels,skill_names){
    	var textSkillLevels = ["No practicado","En dificultades","Practicado","Nivel 1","Nivel 2","Dominado"];
    	console.log(skill_names);
    	console.log(skill_levels);
    	/*for (var i=0;i<skill_names.length;i++){
    		skill_names[i]=skill_names[i].substring(0,10);
    	}*/
    	$('#skills_boxplot').highcharts({

	        chart: {
	            type: 'boxplot'
	        },

	        title: {
	            text: 'Habilidades practicadas'
	        },

	        legend: {
	            enabled: false
	        },

	        xAxis: {
	            categories: skill_names,
	            title: {
	                text: 'Habilidad: '
	            }
	        },

	        yAxis: {
	            title: {
	                text: 'Nivel alcanzado'
	            },
	            labels: {
		            formatter: function() {
		                return textSkillLevels[this.value];
		            }
		        },
		        tickInterval: 1,
		        max: 5
	        },

	        series: [{
	            name: 'Niveles',
	            data: skill_levels,
	            tooltip: {
	                headerFormat: '<em>Habilidad: {point.key}</em><br/>'
	            }
	        }]

	    });
    }


    function drawHistogram(min_grade, max_grade, grades, bins){
			
			var values = grades;
			
			// Formatters for counts and times (converting numbers to Dates).
			var formatCount = d3.format(",.0f");

			var margin = {top: 10, right: 10, bottom: 25, left: 10},
			    widthg = 480 - margin.left - margin.right,
			    heightg = 200 - margin.top - margin.bottom;

			var x = d3.scale.linear()
			    .domain([min_grade,max_grade])
			    .range([0, widthg]);

			// Generate a histogram using user-specified uniformly-spaced bins.
			var dataHistogram = d3.layout.histogram()
			    .bins(x.ticks(bins))
			    (values);
			//console.log(values.length);
			var y = d3.scale.linear()
			    .domain([0, d3.max(dataHistogram, function(d) { return d.y; })])
			    .range([heightg,0]);

			var xAxis = d3.svg.axis()
			    .scale(x)
			    .orient("bottom");
			    //.tickFormat(formatMinutes);

			var svg = d3.select("#resumen_graph").append("svg")
			    .attr("width", widthg + margin.left + margin.right)
			    .attr("height", heightg + margin.top + margin.bottom)
			  .append("g")
			    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			var bar = svg.selectAll(".bar")
			    .data(dataHistogram)
			  .enter().append("g")
			    .attr("class", "bar")
			    .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

			bar.append("rect")
			    .attr("x", (widthg + margin.left + margin.right)/100)
			    .attr("width", (widthg + margin.left + margin.right)/bins - 15)//x(dataHistogram[0].dx) - 1)
			    //.attr("height", function(d) { console.log(y(d.y));return heightg - y(d.y); });
			    .attr("height", function(d) { return heightg - y(d.y); });

			bar.append("text")
			    .attr("dy", ".75em")
			    .attr("y", 6)
			    .attr("x", (widthg/bins - 10)/2 )//x(dataHistogram[0].dx) / 2)
			    .attr("text-anchor", "middle")
			    .text(function(d) { return formatCount(d.y); });

			svg.append("g")
			    .attr("class", "x axis")
			    .attr("transform", "translate(0," + heightg + ")")
			    .call(xAxis);

	}
		
		function noEvaluarTodos(){
			{% if students %}
				$("#sinEvaluar").empty();
				$("#Evaluados").empty();
				{% for student in students %}
					$("#sinEvaluar").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
				{% endfor %}
			{% endif %}
		}
		
		function EvaluarTodos(){
			{% if students %}
				$("#sinEvaluar").empty();
				$("#Evaluados").empty();
				{% for student in students %}	
					$("#Evaluados").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
				{% endfor %}
			{% endif %}
		}
	    
	    function start(e) {
	        e.dataTransfer.effecAllowed = 'move'; // Define el efecto como mover (Es el por defecto)
	        e.dataTransfer.setData("Data", e.target.id); // Coje el elemento que se va a mover
	        e.dataTransfer.setDragImage(e.target, 0, 0); // Define la imagen que se vera al ser arrastrado el elemento y por donde se coje el elemento que se va a mover (el raton aparece en la esquina sup_izq con 0,0)
	        e.target.style.opacity = '0.4'; 
	    };

	    function end(e){
	        e.target.style.opacity = ''; // Pone la opacidad del elemento a 1           
	        e.dataTransfer.clearData("Data");
	    };

	    function enter(e) {
	        e.target.style.border = '3px dotted #555'; 
	    };

	    function leave(e) {
	        e.target.style.border = ''; 
	    };

	    function over(e) {
	        var elemArrastrable = e.dataTransfer.getData("Data"); // Elemento arrastrado
	        var id = e.target.id; // Elemento sobre el que se arrastra
	        
	        // return false para que se pueda soltar
	        if (id == 'sinEvaluar'){
	            return false; // Cualquier elemento se puede soltar sobre el div destino 1
	        }

	        if (id == 'Evaluados'){
	            return false; // En el Evaluados se puede soltar cualquier elemento menos el elemento con id=arrastrable3
	        }   
	    };

	    function drop(e){

	        var elementoArrastrado = e.dataTransfer.getData("Data"); // Elemento arrastrado
	        e.target.appendChild(document.getElementById(elementoArrastrado));
	        e.target.style.border = '';  // Quita el borde
	        tamContX = $('#'+e.target.id).width();
	        tamContY = $('#'+e.target.id).height();

	        tamElemX = $('#'+elementoArrastrado).width();
	        tamElemY = $('#'+elementoArrastrado).height();

	        posXCont = $('#'+e.target.id).position().left;
	        posYCont = $('#'+e.target.id).position().top;

	    }
		
		function fillParameters(id) {
			$("#parametros").empty();
			$("#parametros").append("<div><strong>Parámetros</strong></div>");
			{% for config in assesment_configs %}
				if ({{config.id_assesment_config}}== id){
					$("#parametros").append("<div><IMG style='width:13px;height:13px;margin-right:5px' SRC='{% static 'img/leaf.png'%}'>Porcentaje de aprobación: {{ config.approval_percentage }}</div>");
					$("#parametros").append("<div><IMG style='width:13px;height:13px;margin-right:5px' SRC='{% static 'img/leaf.png'%}'>Importancia de Skill: {{ config.importance_skill_level }}</div>");	
					$("#parametros").append("<div><IMG style='width:13px;height:13px;margin-right:5px' SRC='{% static 'img/leaf.png'%}'>Importancia de Recomendaciones: {{ config.importance_completed_rec }}</div>");
					document.getElementById("input_id_config").value = "{{config.id_assesment_config}}";
				}
			{% endfor %}
			fillSkills(id);
			{% for class in classroom %}
				document.getElementById("input_id_class").value = "{{class.id_class}}";
			{% endfor %}
		};
		
		function fillSkills(id_config){
			$.ajax({
				url: "{% url 'evaluations:getSkillAssesment' 1 %}",
				type: "POST",
				data: {id_asses_config: id_config},
				success: function (response) {
					skills = JSON.parse(response);
					$("#skills").empty();
					$("#skills").append("<div><strong>Habilidades</strong></div>");
					for(var i=0;i<skills.length;i++){
						$("#skills").append("<div><IMG style='width:13px;height:13px;margin-right:5px' SRC='{% static 'img/check.svg'%}'>"+skills[i]['fields']['name_spanish']+"</div>");					
					}
				}
			});
		}
		
		function realizarEvaluacion(){
			var openDiv = document.getElementById('Evaluados'); 
			var cuadritos = openDiv.getElementsByClassName('cuadradito')
			var kaids =[];
			validarEvaluacion();
			if (validarRealizarEvaluacion() || validarEvaluacion()){
				$(".response").remove();
				Loading();
				$("#popup_evaluacion").append("<p class='response'>Guardando...</p>");
				$("#hover").css('pointer-events','none');
				$("#close").css('pointer-events','none');
				$("a").css('pointer-events','none');
				$("input").css('pointer-events','none');
				$("button").css('pointer-events','none');
				$("img").css('pointer-events','none');
				
				
				$('#button_realizar').hide();
				$('#button_cancelar').hide();

				for (var i = 0; i < cuadritos.length; i++) {
					kaids.push({
						kaid_student:cuadritos[i].id
					});
				}
				$("input[name='input_kaid']").val(JSON.stringify(kaids))
				$.ajax({
					url: "{% url 'evaluations:newAssesment3' %}",
					type: "POST",
					data: $("#formJson").serialize(),
					success: function(response){
						location.reload();
					}
				});
			}
			else{
				$("#hover").fadeIn().css('display', '');
    			$("#popupEvaluacion").empty();
    			$("#popupEvaluacion").append("<p>Datos mal ingresados o incompletos, revise los campos incompletos o en color <strong><font color='#C30202'>rojo</font></strong></p>");
    			$("#popup_error").fadeIn().css('display', '');
			}
		}
		function validarEvaluacion(){
			flag = true
			var openDiv = document.getElementById('Evaluados'); 
			var cuadritos = openDiv.getElementsByClassName('cuadradito')
			date_start = document.getElementById("fecha_inicio").value;
			date_end = document.getElementById("fecha_termino").value;
			combo_box = document.getElementById("comboBox").selectedIndex;
			var startDate = new Date(date_start);
			var endDate = new Date(date_end);
			todayDate = new Date();
			
			if (cuadritos.length==0){
				$('#Evaluados').css("border", "1px solid #C30202");
				flag = false;
			}else{
				$('#Evaluados').css("border", "1px solid #D9D9D9");
			}
			if(date_start == null || date_start.length == 0 || /^\s+$/.test(date_start)) {
				$('#fecha_inicio').css('color', '#C30202');
				flag = false;
			}else{
				$('#fecha_inicio').css('color', '#000000');
			}
			if(date_end == null || startDate > endDate || endDate < todayDate || date_end.length == 0 || /^\s+$/.test(date_end)) {
				$('#fecha_termino').css('color', '#C30202');
				flag = false;
			}else{
				$('#fecha_termino').css('color', '#000000');
			}
			if( combo_box == null || combo_box == 0 ) {
				$('#comboBox').css('color', '#C30202');
				flag = false;
			}else{
				$('#comboBox').css('color', '#000000');
			}
			return flag
		}
		function validarRealizarEvaluacion(){
			$("#botonesEvaluacion").hide();			
			input_name = document.getElementById("input_nombre").value;
			grade_min = document.getElementById("nota_minima").value;
			grade_max = document.getElementById("nota_maxima").value;
			approval_percentage = document.getElementById("nota_aprobacion").value;
			flag = true;
			
			if( input_name == null || input_name.length == 0 || /^\s+$/.test(input_name) ) {
				$('#input_nombre').css('color', '#C30202');
				flag = false;
			}else{
				$('#input_nombre').css('color', '#000000');
			}
			if(grade_min == null || grade_min<0 || grade_min.length == 0 || /^\s+$/.test(grade_min)) {
				$('#nota_minima').css('color', '#C30202');
				flag = false;
			}else{
				$('#nota_minima').css('color', '#000000');
			}
			if(grade_max == null || grade_min>grade_max || grade_max.length == 0 || /^\s+$/.test(grade_max)) {
				$('#nota_maxima').css('color', '#C30202');
				flag = false;
			}else{
				$('#nota_maxima').css('color', '#000000');
			}
			if(approval_percentage == null || grade_min>approval_percentage || approval_percentage>grade_max || approval_percentage.length == 0 || /^\s+$/.test(approval_percentage)) {
				$('#nota_aprobacion').css('color', '#C30202');
				flag = false;
			}else{
				$('#nota_aprobacion').css('color', '#000000');
			}
			return flag;
		}
		function modificarNota(){
			$(".response").remove();
			Loading();
			$("#popup_evaluacion").append("<p class='response'>Editando...</p>");
			$("#hover").css('pointer-events','none');
			$("#close").css('pointer-events','none');
			$("a").css('pointer-events','none');
			$("input").css('pointer-events','none');
			$("button").css('pointer-events','none');
			$("img").css('pointer-events','none');

			var comentario = $('#textarea_coment').val()
			$("input[name='input_comment']").val(comentario)
			$.ajax({
				url: "{% url 'evaluations:updateGrade' %}",
				type: "POST",
				data: $("#formGrade").serialize(),
				success: function(response){
					location.reload();
				}
			});		
			//$('#hover').fadeOut();
			$('#popup').fadeOut();
		}
		function nuevaEvaluacion(){
			$("#flechaTodos").attr('onClick','EvaluarTodos()');
			$("#flechaNinguno").attr('onClick','noEvaluarTodos()');
			$("input[name='input_nombre']").prop('disabled', false);
			$("input[name='fecha_inicio']").prop('disabled', false);
			$("input[name='fecha_termino']").prop('disabled', false);
			$("input[name='nota_maxima']").prop('disabled', false);
			$("input[name='nota_minima']").prop('disabled', false);
			$("input[name='nota_aprobacion']").prop('disabled', false);
			$("input[name='bono_esfuerzo']").prop('disabled', false);
			$('#comboBox').prop('disabled', false);
			$("input[name='fecha_termino']").attr('onchange', 'validarRealizarEvaluacion()');
			$("input[name='fecha_termino']").attr('onkeyup', 'validarRealizarEvaluacion()');
			showDiv();
			evReady = 1;
			$('#estudiantesEvaluados').empty();
			$('#estudiantesEvaluados').append('<strong>Estudiantes a Calificar</strong>');
			$('#button_realizar').show();
			$('#button_editar').hide();
			$('#comboBox').prop('disabled', false);
			$("#comboBox option[value=0]").prop('selected', 'selected').change();
			$("input[name='input_nombre']").val("");
			$("input[name='fecha_inicio']").val("");
			$("input[name='fecha_termino']").val("");
			$("input[name='nota_maxima']").val("");
			$("input[name='nota_minima']").val("");
			$("input[name='nota_aprobacion']").val("");
			$("input[name='bono_esfuerzo']").val("");
			noEvaluarTodos();
		}
		function evaluationReady(){
			$('#hover').fadeIn();
			$("#popupEvaluacion").empty();
    		$("#popupEvaluacion").append("<p>Datos mal ingresados o incompletos, revise los campos incompletos o en color <strong><font color='#C30202'>rojo</font></strong></p>");
    		$("#popup_error").fadeIn().css('display', '');
			$("#evAceptar").on("click",function(){
				evReady=0;
				$('#hover').fadeOut();
				$("#popup_error").fadeOut();
				return true
			});
			$("#evCancelar").on("click",function(){
				$('#hover').fadeOut();
				$("#popup_error").fadeOut();
				return false
			});
		}
		function showEvaluation(id_assesment){
			$("#botonesEvaluacion").show();
			if(evReady==1){
				$('#hover').fadeIn();
				$("#popupEvaluacion").empty();
	    		$("#popupEvaluacion").append("<p>Se descartaran los cambios de la nueva evaluación no guardada</p>");
	    		$("#popup_error").fadeIn().css('display', '');
				$("#evAceptar").on("click",function(){
					evReady=0;
					$('#hover').fadeOut();
					$("#popup_error").fadeOut();
					showDiv();	
					showAssesment(id_assesment);
					return true					
				});
			}else{
				showDiv();
				showAssesment(id_assesment);
				return false
			}
		}
		function isEvaluation(id_assesment){
			$("#botonesEvaluacion").show();
			if(evReady==1){
				$('#hover').fadeIn();
				$("#popupEvaluacion").empty();
	    		$("#popupEvaluacion").append("<p>Se descartaran los cambios de la nueva evaluación no guardada</p>");
	    		$("#popup_error").fadeIn().css('display', '');
				$("#evAceptar").unbind();
				$("#evAceptar").on("click",function(){
					evReady=0;
					$('#hover').fadeOut();
					$("#popup_error").fadeOut();
					showDiv();
					editAssesment(id_assesment);
					return true					
				});
				$("#evCancelar").on("click",function(){
					$('#hover').fadeOut();
					$("#popup_error").fadeOut();
					return false
				});
			}else{
				showDiv();
				editAssesment(id_assesment);
				return false
			}
		}
		function cancelNewEv(){
			$("#botonesEvaluacion").show();
			if(evReady==1){
				$('#hover').fadeIn();
				$("#popupEvaluacion").empty();
	    		$("#popupEvaluacion").append("<p>Se descartaran los cambios de la nueva evaluación no guardada</p>");
	    		$("#popup_error").fadeIn().css('display', '');
				$("#evAceptar").unbind();
				$("#evAceptar").on("click",function(){
					evReady=0;
					$('#hover').fadeOut();
					$("#popup_error").fadeOut();
					hideDiv();
					return true;				
				});
				$("#evCancelar").on("click",function(){
					$('#hover').fadeOut();
					$("#popup_error").fadeOut();
					return false
				});
			}else{
				hideDiv()
				return true
			}
		}
		function showAssesment(id_assesment){	
			$.ajax({
				url: "{% url 'evaluations:getAssesment' %}",
				async:false,
				type: "POST",
				data: {assesment:id_assesment},
				success: function(response){
					json_assesment=JSON.parse(response);
					$("input[name='input_nombre']").val(json_assesment[0]['fields']['name']);
					$("input[name='fecha_inicio']").val(json_assesment[0]['fields']['start_date']);
					$("input[name='fecha_termino']").val(json_assesment[0]['fields']['end_date']);
					$("input[name='nota_maxima']").val(json_assesment[0]['fields']['max_grade']);
					$("input[name='nota_minima']").val(json_assesment[0]['fields']['min_grade']);
					$("input[name='nota_aprobacion']").val(json_assesment[0]['fields']['approval_grade']);
					$("input[name='bono_esfuerzo']").val(json_assesment[0]['fields']['max_effort_bonus']);
					$("#comboBox option[value="+json_assesment[0]['fields']['id_assesment_conf']+"]").prop('selected', 'selected').change();
					$('#comboBox').prop('disabled', true);
					$('#estudiantesEvaluados').empty();
					$('#estudiantesEvaluados').append('<strong>Estudiantes a Calificar</strong>');
				}
			});
			M_student = [];
			$.ajax({
				url: "{% url 'evaluations:getStudentAssesment' %}",
				async:false,
				type: "POST",
				data: {assesment:id_assesment},
				success: function(response){
					json_student=JSON.parse(response);
					for (i=0;i<json_student.length;i++){
						M_student.push(json_student[i]['fields']['kaid_student']);
					}
				}
			});
			{% if students %}
				$("#sinEvaluar").empty();
				$("#Evaluados").empty();
				{% for student in students %}
				if(M_student.indexOf("{{student.kaid_student}}") != -1){
					$("#Evaluados").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
				}else{
					$("#sinEvaluar").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
				}
				{% endfor %}
			{% endif %}
			$("input[name='input_nombre']").prop('disabled', true);
			$("input[name='fecha_inicio']").prop('disabled', true);
			$("input[name='fecha_termino']").prop('disabled', true);
			$("input[name='nota_maxima']").prop('disabled', true);
			$("input[name='nota_minima']").prop('disabled', true);
			$("input[name='nota_aprobacion']").prop('disabled', true);
			$("input[name='bono_esfuerzo']").prop('disabled', true);
			$('#comboBox').prop('disabled', true);
			$('#button_editar').hide()
			$('#button_realizar').hide()
			$("#flechaTodos").attr('onClick','disabled');
			$("#flechaNinguno").attr('onClick','disabled');
			$("input[name='fecha_termino']").attr('onchange', '');
			$("input[name='fecha_termino']").attr('onkeyup', '');


		}
		function editAssesment(id_assesment){	
			$("#flechaTodos").attr('onClick','EvaluarTodos()');
			$("#flechaNinguno").attr('onClick','noEvaluarTodos()');
			$("input[name='input_nombre']").prop('disabled', false);
			$("input[name='fecha_inicio']").prop('disabled', false);
			$("input[name='fecha_termino']").prop('disabled', false);
			$("input[name='nota_maxima']").prop('disabled', false);
			$("input[name='nota_minima']").prop('disabled', false);
			$("input[name='nota_aprobacion']").prop('disabled', false);
			$("input[name='bono_esfuerzo']").prop('disabled', false);
			$('#comboBox').prop('disabled', false);
			$("input[name='fecha_termino']").attr('onchange', 'validarRealizarEvaluacion()');
			$("input[name='fecha_termino']").attr('onkeyup', 'validarRealizarEvaluacion()');
			$.ajax({
				url: "{% url 'evaluations:getAssesment' %}",
				async:false,
				type: "POST",
				data: {assesment:id_assesment},
				success: function(response){
					json_assesment=JSON.parse(response);
					$("input[name='input_nombre']").val(json_assesment[0]['fields']['name']);
					$("input[name='fecha_inicio']").val(json_assesment[0]['fields']['start_date']);
					$("input[name='fecha_termino']").val(json_assesment[0]['fields']['end_date']);
					$("input[name='nota_maxima']").val(json_assesment[0]['fields']['max_grade']);
					$("input[name='nota_minima']").val(json_assesment[0]['fields']['min_grade']);
					$("input[name='nota_aprobacion']").val(json_assesment[0]['fields']['approval_grade']);
					$("input[name='bono_esfuerzo']").val(json_assesment[0]['fields']['max_effort_bonus']);
					$("#comboBox option[value="+json_assesment[0]['fields']['id_assesment_conf']+"]").prop('selected', 'selected').change();
					$('#comboBox').prop('disabled', true);
					$('#estudiantesEvaluados').empty();
					$('#estudiantesEvaluados').append('<strong>Estudiantes Calificados</strong>');
				}
			});
			M_student = [];
			$.ajax({
				url: "{% url 'evaluations:getStudentAssesment' %}",
				async:false,
				type: "POST",
				data: {assesment:id_assesment},
				success: function(response){
					json_student=JSON.parse(response);
					for (i=0;i<json_student.length;i++){
						M_student.push(json_student[i]['fields']['kaid_student']);
					}
				}
			});
			{% if students %}
				$("#sinEvaluar").empty();
				$("#Evaluados").empty();
				{% for student in students %}
				if(M_student.indexOf("{{student.kaid_student}}") != -1){
					$("#Evaluados").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
				}else{
					$("#sinEvaluar").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
				}
				{% endfor %}
			{% endif %}
			validarRealizarEvaluacion()
			validarEvaluacion();
			$("input[name='input_id_assesment']").val(id_assesment)
			$('#button_realizar').hide()
			$('#button_editar').show()
			$("input[name='fecha_termino']").attr('onchange', 'validarRealizarEvaluacion()');
			$("input[name='fecha_termino']").attr('onkeyup', 'validarRealizarEvaluacion()');
		}
		function updateAssesment(){
			id_assesment = $("input[name='input_id_assesment']").val();
			var openDiv = document.getElementById('Evaluados'); 
			var cuadritos = openDiv.getElementsByClassName('cuadradito')
			var kaids =[];
			validarEvaluacion();
			if (validarRealizarEvaluacion()||validarEvaluacion()){
				$(".response").remove();
				Loading();
				$("#popup_evaluacion").append("<p class='response'>Editando...</p>");
				$("#hover").css('pointer-events','none');
				$("#close").css('pointer-events','none');
				$("a").css('pointer-events','none');
				$("input").css('pointer-events','none');
				$("button").css('pointer-events','none');
				$("img").css('pointer-events','none');
				for (var i = 0; i < cuadritos.length; i++) {
					kaids.push({
						kaid_student:cuadritos[i].id
					});
				}
				$("input[name='input_kaid']").val(JSON.stringify(kaids))
				$.ajax({
					url: "{% url 'evaluations:updateAssesment' %}",
					type: "POST",
					data: $("#formJson").serialize(),
					success: function(response){
						location.reload();
					}
				});

			}
			else{
				$("#hover").fadeIn().css('display', '');
    			$("#popupEvaluacion").empty();
    			$("#popupEvaluacion").append("<p>Datos mal ingresados o incompletos, revise los campos incompletos o en color <strong><font color='#C30202'>rojo</font></strong></p>");
    			$("#popup_error").fadeIn().css('display', '');
			}

		}
		function Loading(){
			$("#popup_evaluacion").fadeIn();
  			$("#hover").fadeIn();
  			$("#profile-throbber2").show();
			$(".vaciar").empty();
			location.reload();
		}
		function resumenAssesment(id_assesment){
			$("#hover").fadeIn().css('display', '');
		    $("#popup_resumen").fadeIn().css('display', '');
		    $("#resumen_data").empty();
		    $("#resumen_skill").empty();
		    //$("#resumen_grade").empty();
		    //$("#resumen_grade_count").empty();
		    $("#resumen_graph").empty();
		    id_assesment_confi=''
		    aux=-1
		    
			for (var i = 0; i < assesments.length; i++){
				if (assesments[i]['id']==id_assesment){
					id_assesment_confi=assesments[i]['id_config']
					aux=i
				}
			}
			approval_percentage = assesments[aux].approval_percentage
			nmin = assesments[aux]['max_grade'];
			pmin = 0;
			nmax = assesments[aux]['min_grade'];
			pmax = 0;
			nmedia = (nmin-nmax)*(approval_percentage/100) + nmax;
			aprobados = 0;
			reprobados = 0;
			for (var i = 0; i < students.length; i++) {
				actualGrade = students[i]["assesment"+id_assesment].grade
				if (actualGrade<nmin){
					nmin=actualGrade;
					pmin = students[i]["assesment"+id_assesment].performance_points
				}
				if (actualGrade>nmax){
					nmax=actualGrade;
					pmax = students[i]["assesment"+id_assesment].performance_points
				}
				if (actualGrade<nmedia){
					reprobados++;
				}else{
					aprobados++;
				}
			};

			//student=assesments[aux]['assesment_student']
			$('#resumen_data').append("<p><strong> Nombre:</strong> "+assesments[aux]['name']+" </p>");
			$('#resumen_data').append("<p><strong> Inicio:</strong> "+assesments[aux]['start_date']+" </p>");
			$('#resumen_data').append("<p><strong> Término:</strong> "+assesments[aux]['end_date']+" </p><br>");
			$('#resumen_data').append("<p><strong> Puntaje Máximo:</strong> "+pmax+" </p>");
			$('#resumen_data').append("<p><strong> Puntaje Mínimo:</strong> "+pmin+" </p><br>");
			$('#resumen_data').append("<p><strong> Nota Máxima:</strong> "+nmax+" </p>");
			$('#resumen_data').append("<p><strong> Nota Mínima:</strong> "+nmin+" </p><br>");
			$("#resumen_data").append("<p><strong> Alumnos Participantes:</strong> "+students.length+"</p><br><hr>");
			$('#resumen_data').append("<p><strong> Aprobados:</strong> "+aprobados+" </p>");
			$('#resumen_data').append("<p><strong> Reprobados:</strong> "+reprobados+" </p><br>");
					
			var grade_order = [];
			for (var k=0; k<students.length; k++){
				grade_order.push(students[k]['assesment'+id_assesment]['grade']);
			}

			$.ajax({
				url: "{% url 'evaluations:getSkillAssesment' 1 %}",
				async:false,
				type: "POST",
				data: {id_asses_config: id_assesment_confi},
				success: function (response) {
					skills = JSON.parse(response);
					$("#resumen_skills").append("<h4>Habilidades:</p>");
					for(var i=0;i<skills.length;i++){
						$("#resumen_skill").append("<li>"+skills[i]['fields']['name_spanish']+"</li>");					
					}
				}
			});
			
			/*for (var k=0; k<students.length; k++){
				grade_order.push(students[k]['assesment'+id_assesment]['grade']);
			}*/
			skills_sample=[];
			console.log(students);
			if (students){
				console.log(students[0]['assesment'+id_assesment]["skills"]);
				skills_sample=students[0]['assesment'+id_assesment]["skills"];
			}
			skill_names=skills_sample.map(function(d){ 
					return d[0];//the first attribute of each skills is its spanish name
			});
			console.log('assesment'+id_assesment);
			var all_skill_levels = [];
			for (var j=0; j<skills_sample.length; j++){
				reached_skill_levels=[]
				for (var s=0; s<students.length; s++){
					student_skill_level=students[s]['assesment'+id_assesment]["skills"][j][5];
					//console.log(student_skill_level);
					if (student_skill_level){
						switch (student_skill_level){
							case "unstarted":
								reached_skill_levels.push(0);
								//reached_skill_levels[0]++;
								break;
							case "struggling":
								reached_skill_levels.push(1);
								//reached_skill_levels[1]++;
								break;
							case "practiced":
								reached_skill_levels.push(2);
								//reached_skill_levels[2]++;
								break;
							case "mastery1":
								reached_skill_levels.push(3);
								//reached_skill_levels[3]++;
								break;
							case "mastery2":
								reached_skill_levels.push(4);
								//reached_skill_levels[4]++;
								break;
							case "mastery3":
								reached_skill_levels.push(5);
								//reached_skill_levels[4]++;
								break;
							default:
								reached_skill_levels.push(0);
								//reached_skill_levels[0]++;
						}
					}else{
						reached_skill_levels.push(0);
					}
					
				}
				console.log("reached_skill_levels");
				console.log(reached_skill_levels);
				reached_skill_levels.sort(function(a, b){return a-b});
				var min = reached_skill_levels[0];
				var q1 = percentile(reached_skill_levels,0.25);
				var median = percentile(reached_skill_levels,0.50);
				var q3 =  percentile(reached_skill_levels,0.75);
				var max = reached_skill_levels[reached_skill_levels.length-1];
				var quartiles = [min,q1,median,q3,max];
				console.log(quartiles);
				all_skill_levels.push(quartiles);
			}
			console.log(all_skill_levels);
			//console.log(student);
			drawSkillsBoxPlot(all_skill_levels,skill_names);
			//drawSkillsBoxPlot();
			drawHistogram(assesments[aux]['min_grade'],assesments[aux]['max_grade'],grade_order,10);
			//deciles(grade_order,assesments[aux]['min_grade'],assesments[aux]['max_grade'])
			$('.highcharts-button').css('visibility','hidden');	
			$('text:contains("Highcharts.com")').css('visibility','hidden');	


		}

		function deciles(arg_grade,min,max){
			arg_grade=arg_grade.sort();
			decil = (arg_grade.length)/10
			c = 0
			c1 = 1
			promedio = 0
			for (var a=0; a<arg_grade.length;a++){
				//$("#resumen_grade").append("<p>"+grade_order[a]+"</p>");
				dec = decil*c1
				if (a>dec){
					promedio=promedio/c
					$("#resumen_grade").append("<p>"+promedio+"</p>");
					promedio = 0
					c = 0
					c1++
				}else{
					promedio=promedio + arg_grade[a]
					c++
				}
			}
			
			step = (max-min)/10;
			d0 = 0
			d1 = 0
			d2 = 0
			d3 = 0
			d4 = 0
			d5 = 0
			d6 = 0
			d7 = 0
			d8 = 0
			d9 = 0
			//console.log(d3.max([3,4,5,199]));
			for (var b=0;b<arg_grade.length;b++){
				if (arg_grade[b]<=(min + 1*step)){
					d0++
				}
				if (arg_grade[b]<=(min + 2*step) && arg_grade[b]>(min + 1*step)){
					d1++
				}
				if (arg_grade[b]<=(min + 3*step) && arg_grade[b]>(min + 2*step)){
					d2++
				}
				if (arg_grade[b]<=(min + 4*step) && arg_grade[b]>(min + 3*step)){
					d3++
				}
				if (arg_grade[b]<=(min + 5*step) && arg_grade[b]>(min + 4*step)){
					d4++
				}
				if (arg_grade[b]<=(min + 6*step) && arg_grade[b]>(min + 5*step)){
					d5++
				}
				if (arg_grade[b]<=(min + 7*step) && arg_grade[b]>(min + 6*step)){
					d6++
				}
				if (arg_grade[b]<=(min + 8*step) && arg_grade[b]>(min + 7*step)){
					d7++
				}
				if (arg_grade[b]<=(min + 9*step) && arg_grade[b]>(min + 8*step)){
					d8++
				}
				if (arg_grade[b]>(min + 9*step)){
					d9++
				}
			}
			/*$("#resumen_grade_count").append("<p>d0: "+d0+"</p>");
			$("#resumen_grade_count").append("<p>d1: "+d1+"</p>");
			$("#resumen_grade_count").append("<p>d2: "+d2+"</p>");
			$("#resumen_grade_count").append("<p>d3: "+d3+"</p>");
			$("#resumen_grade_count").append("<p>d4: "+d4+"</p>");
			$("#resumen_grade_count").append("<p>d5: "+d5+"</p>");
			$("#resumen_grade_count").append("<p>d6: "+d6+"</p>");
			$("#resumen_grade_count").append("<p>d7: "+d7+"</p>");
			$("#resumen_grade_count").append("<p>d8: "+d8+"</p>");
			$("#resumen_grade_count").append("<p>d9: "+d9+"</p>");*/
			
			//testGraphic();
			//makeGraphic();
		}

/*function makeGraphic(){
			// Generate a Bates distribution of 10 random variables.
			// Generate a log-normal distribution with a median of 30 minutes.
var values = d3.range(1000).map(d3.random.logNormal(Math.log(30), .4));

// Formatters for counts and times (converting numbers to Dates).
var formatCount = d3.format(",.0f"),
    formatTime = d3.time.format("%H:%M"),
    formatMinutes = function(d) { return formatTime(new Date(2012, 0, 1, 0, d)); };

var margin = {top: 10, right: 30, bottom: 30, left: 30},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.linear()
    .domain([0, 120])
    .range([0, width]);

// Generate a histogram using twenty uniformly-spaced bins.
var data = d3.layout.histogram()
    .bins(x.ticks(20))
    (values);

var y = d3.scale.linear()
    .domain([0, d3.max(data, function(d) { return d.y; })])
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .tickFormat(formatMinutes);

var svg = d3.select("#resumen_graph").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var bar = svg.selectAll(".bar")
    .data(data)
  .enter().append("g")
    .attr("class", "bar")
    .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

bar.append("rect")
    .attr("x", 1)
    .attr("width", x(data[0].dx) - 1)
    .attr("height", function(d) { return height - y(d.y); });

bar.append("text")
    .attr("dy", ".75em")
    .attr("y", 6)
    .attr("x", x(data[0].dx) / 2)
    .attr("text-anchor", "middle")
    .text(function(d) { return formatCount(d.y); });

svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

		}*/
		
		
	</script>

<script language="JavaScript" type="text/javascript">

cntdwns = document.getElementsByClassName("counter");
for (var i = cntdwns.length - 1; i >= 0; i--) {
	StartCountDown(cntdwns[i].id,endDates[i])
}
  
  function StartCountDown(myDiv,myTargetDate)
  {
    var dthen   = new Date(myTargetDate);
    var dnow    = new Date();
    ddiff       = new Date(dthen-dnow);
    gsecs       = Math.floor(ddiff.valueOf()/1000);
    CountBack(myDiv,gsecs);
  }
  
  function Calcage(secs, num1, num2)
  {
    s = ((Math.floor(secs/num1))%num2).toString();
    if (s.length < 2) 
    {   
      s = "0" + s;
    }
    return (s);
  }
  
  function CountBack(myDiv, secs)
  {
    var DisplayStr;
    var DisplayFormat = "%%D%%d%%H%%h%%M%%m%%S%%s";
    DisplayStr = DisplayFormat.replace(/%%D%%/g,    Calcage(secs,86400,100000));
    DisplayStr = DisplayStr.replace(/%%H%%/g,       Calcage(secs,3600,24));
    DisplayStr = DisplayStr.replace(/%%M%%/g,       Calcage(secs,60,60));
    DisplayStr = DisplayStr.replace(/%%S%%/g,       Calcage(secs,1,60));
    if(secs > 0)
    {   
      document.getElementById(myDiv).innerHTML = DisplayStr;
      setTimeout("CountBack('" + myDiv + "'," + (secs-1) + ");", 990);
    }
    else
    {
      document.getElementById(myDiv).innerHTML = "Evaluación Lista";
    }
  }

  function showDiv(){
  	if( !($('#contenido_a_mostrar').is(":visible")) ){
    	$('#contenido_a_mostrar').toggle('blind',1000)
	}
  }
  
  function hideDiv(){
  	if( $('#contenido_a_mostrar').is(":visible") ){
    	$('#contenido_a_mostrar').toggle('blind',1000)
	}
  }
  function autoCalculateGrade(){
  	sugerida = parseFloat($('#input_grade').val()) + parseFloat($('#input_bonificacion').val());
  	sugerida = Math.round(sugerida*10)/10;
  	autoGrade = sugerida + parseFloat($('#input_grade_teacher').val());
  	autoGrade = Math.round(autoGrade*10)/10;
  	$('#sugerida').val(sugerida);
  	if (autoGrade>0){
  		$('#final').val(autoGrade);
  	}else{
  		$('#final').val(sugerida);
  	}
  }


</script>

<script type="text/javascript" src="{% static 'js/jquery.nicescroll.min.js' %}"></script>
<script type="text/javascript"> 
    $(document).ready(function () {
    $("#popup_resumen").niceScroll({ cursorwidth:'10px', autohidemode: false, cursorcolor:'#D9D9D9', zindex:'16', railoffset: {top: -150, left: -300} })
    });
    $("#evCancelar").on("click",function(){
					$('#hover').fadeOut();
					$("#popup_error").fadeOut();
					return false
				});
    
    var texts = document.getElementsByTagName("text");
    var n = texts.length;
    for(i=0;i<n;i++){
    	if(texts[i].innerHTML=="S.E."){
    		texts[i].classList.add("SE");
    		$(texts[i]).css('pointer-events','');
    		$(texts[i]).css('cursor','context-menu');
    		$(texts[i]).attr('dx','12');
    	}
    }

    $(".SE").tipsy({ 
	        gravity: 'se',
	        opacity: 1,
	        html: true, 
	        title: function() {
	          return `<ul>
	          		<li>Estudiante sin evaluar</li>
	          		</ul>`;
	        }
	      });



    for (i=0; i<assesments.length; i++){
    	aux="assesment"+assesments[i]["id"];
    	name=assesments[i]["config_name"];
    	percentage=assesments[i]["approval_percentage"];
    	top_score=assesments[i]["top_score"];
    	min=assesments[i]["max_grade"];
    	max=assesments[i]["min_grade"];
    	
    	var th = $("th."+aux);
    	th.tipsy({
    		gravity: 'ne',
	        opacity: 1,
	        html: true, 
	        title: function() {
	        	var d = this.__data__;
	            var id_json_assesment = d.column;
	            name=assesments[id_json_assesment]["config_name"];
    			percentage=assesments[id_json_assesment]["approval_percentage"];
    			top_score=assesments[id_json_assesment]["top_score"];
    			min=assesments[id_json_assesment]["max_grade"];
    			max=assesments[id_json_assesment]["min_grade"];
	          return `<ul>
	          		<li>Nombre de la pauta: `+name+`</li>
	          		<li>% de aprobación: `+percentage+`</li>
	          		<li>Nota máxima: `+min+`</li>
	          		<li>Nota mínima: `+max+`</li>
	          		</ul>`;
	        }
    	});
    	/*columns.push({head_assesment: json["assesments"][i]["name"], column: i, cl: class_id, tooltip: "Nombre: "+json["assesments"][i]["config_name"]+"<hr style=margin: 0>
    	% aprobación: "+json["assesments"][i]["approval_percentage"]+"<hr style=margin: 0>
    	Puntaje máximo: "+json["assesments"][i]["top_score"]+"<hr style=margin: 0>
    	Nota máxima: "+json["assesments"][i]["max_grade"]+"<hr style=margin: 0>
    	Nota mínima: "+json["assesments"][i]["min_grade"], value: d3.f(class_id), type:'numeric'})//html: d3.f('evaluacion')})*/

    }
   

$('#breadcrumb').html('Curso / {{ spanish_classroom }}')

</script>

{% endblock %}